# Pull Request Documentation

## PR Title
fix(cloudwatch): dashboard widgets don't properly support composite alarms

## PR Description

### Issue # (if applicable)

Closes #35001.

### Reason for this change

CloudWatch composite alarms were not displaying correctly in dashboard widgets created with `AlarmWidget`. The issue occurred because `AlarmWidget` always generated `metric` type widgets regardless of the alarm type, but composite alarms require `alarm` type widgets to render properly in the CloudWatch console.

This bug affected users who wanted to visualize composite alarms in their CloudWatch dashboards, as the widgets would fail to display the alarm data correctly. The fix ensures that composite alarms are properly detected and generate the appropriate widget type for correct CloudWatch console rendering.

### Description of changes

This change modifies the `AlarmWidget.toJson()` method in `packages/aws-cdk-lib/aws-cloudwatch/lib/graph.ts` to implement a hybrid approach that generates different widget types based on the alarm type:

- **Hybrid widget generation**: Composite alarms now generate `alarm` type widgets (status display), while regular alarms continue to generate `metric` type widgets (time series graphs)
- **Enhanced alarm type detection**: Implemented dual detection logic that identifies composite alarms using both `instanceof CompositeAlarm` checks and the `isCompositeAlarm` property
- **Correct widget structure**: Each widget type now uses the appropriate properties structure as required by the CloudWatch console
- **Backward compatibility maintained**: Regular alarms continue to work exactly as before with no API changes
- **Support for imported alarms**: Handles composite alarms imported via `CompositeAlarm.fromCompositeAlarmArn()` through the `isCompositeAlarm` property
- **Comprehensive test coverage**: Updated existing tests and added validation for both widget types

**Key implementation details**:
```typescript
if (isCompositeAlarm) {
  // Generate alarm-type widget for composite alarms (status display)
  return [{
    type: 'alarm',
    properties: {
      title: this.props.title,
      alarms: [this.props.alarm.alarmArn],
    },
  }];
} else {
  // Generate metric-type widget for regular alarms (time series graphs)
  return [{
    type: 'metric',
    properties: {
      view: 'timeSeries',
      annotations: {
        alarms: [this.props.alarm.alarmArn],
      },
      // ... other metric widget properties
    },
  }];
}
```

**Why this approach**: Through investigation, we discovered that composite alarms cannot be displayed in `metric` type widgets (they show "missing or deleted" errors), but work perfectly in `alarm` type widgets. Regular alarms work best in `metric` type widgets for time series visualization. This hybrid approach ensures both alarm types render correctly in the CloudWatch console.

### Describe any new or updated permissions being added

N/A - This change only affects widget JSON generation and does not require any new IAM permissions or resource access patterns.

### Description of how you validated changes

**Unit tests**: Added comprehensive test coverage with 4 new test cases specifically for AlarmWidget behavior:
- `composite alarm widget generates alarm-type widget`: Validates that composite alarms generate `alarm` type widgets with correct properties
- `regular alarm widget maintains metric-type widget behavior`: Ensures backward compatibility for regular metric alarms
- `imported composite alarm using fromCompositeAlarmArn generates alarm-type widget`: Tests support for imported composite alarms
- `alarm widget preserves all properties for both alarm types`: Verifies that all widget properties (dimensions, yAxis, etc.) are preserved regardless of alarm type

**Integration tests**: All existing CloudWatch tests continue to pass (51/51 tests), confirming no regressions in existing functionality

### Checklist
- [x] My code adheres to the [CONTRIBUTING GUIDE](https://github.com/aws/aws-cdk/blob/main/CONTRIBUTING.md) and [DESIGN GUIDELINES](https://github.com/aws/aws-cdk/blob/main/docs/DESIGN_GUIDELINES.md)

----

*By submitting this pull request, I confirm that my contribution is made under the terms of the Apache-2.0 license*

## Additional Context
- **Related Issues**: Closes #35001
- **Dependencies**: No dependency changes required
- **Documentation Updates**: No README updates needed - this is an internal bug fix
- **Follow-up Work**: None required - this is a complete fix for the composite alarm widget issue

## Review Guidelines
- **Focus Areas**: 
  - Alarm type detection logic in `AlarmWidget.toJson()`
  - Widget JSON structure for both alarm types
  - Test coverage for composite vs regular alarms
- **Testing Notes**: 
  - Verify all 4 new test cases pass
  - Confirm existing CloudWatch tests remain unaffected
  - Check widget JSON output matches CloudWatch console requirements
- **Risk Assessment**: 
  - Low risk - maintains backward compatibility
  - No breaking changes to public API
  - Isolated change to widget generation logic only