name: Security Report
on:
  workflow_run:
    workflows: ["Security Guardian"]
    types: [completed]

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
      actions: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: security-guardian-reports
          path: test-results/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          repository: ${{ github.repository }}
      
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=$(cat test-results/pr_number)" >> "$GITHUB_OUTPUT"
          echo "pr_sha=$(cat test-results/pr_sha)" >> "$GITHUB_OUTPUT"
          echo "PR: $(cat test-results/pr_number), SHA: $(cat test-results/pr_sha)"
      - name: Publish Security Test Results 
        uses: mikepenz/action-junit-report@v6
        if: always()
        with:
          report_paths: 'test-results/**/cfn-guard-static.xml'
          check_name: 'Security Guardian Results'
          exclude_sources: 'node_modules,dist'
          commit: ${{ steps.pr_info.outputs.pr_sha }}
          check_annotations: true
          comment: true
          pr_id: ${{ steps.pr_info.outputs.pr_number }}
          detailed_summary: true
          include_passed: false
          fail_on_failure: false
          group_suite: true
          include_skipped: false
          check_title_template: '{{TEST_NAME}}'
          include_empty_in_summary: false

      - name: Add disclaimer to static results comment
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Guardian Results')
            );
            
            if (botComment) {
              const disclaimer = '\n\n---\n\n⚠️ **Experimental Feature**: This security report is currently in experimental phase. Results may include false positives and the rules are being actively refined. Please review findings carefully.';
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: botComment.body + disclaimer
              });
            }

      - name: Publish Security Test Results for resolved templates
        uses: mikepenz/action-junit-report@v6
        if: always()
        with:
          report_paths: 'test-results/**/cfn-guard-resolved.xml'
          check_name: 'Security Guardian Results with resolved templates'
          exclude_sources: 'node_modules,dist'
          commit: ${{ steps.pr_info.outputs.pr_sha }}
          check_annotations: true
          comment: true
          pr_id: ${{ steps.pr_info.outputs.pr_number }}
          detailed_summary: true
          include_passed: false
          fail_on_failure: false
          group_suite: true
          include_skipped: false
          check_title_template: '{{TEST_NAME}}'
          include_empty_in_summary: false

      - name: Add disclaimer to resolved results comment
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Guardian Results with resolved templates')
            );
            
            if (botComment) {
              const disclaimer = '\n\n---\n\n⚠️ **Experimental Feature**: This security report is currently in experimental phase. Results may include false positives and the rules are being actively refined. Please review findings carefully.';
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: botComment.body + disclaimer
              });
            }
