{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"0.0.0"},"children":{"volume-initialization-rate-stack":{"id":"volume-initialization-rate-stack","path":"volume-initialization-rate-stack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"0.0.0"},"children":{"SnapshotProvider":{"id":"SnapshotProvider","path":"volume-initialization-rate-stack/SnapshotProvider","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"0.0.0"},"children":{"ServiceRole":{"id":"ServiceRole","path":"volume-initialization-rate-stack/SnapshotProvider/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/SnapshotProvider/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"volume-initialization-rate-stack/SnapshotProvider/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/SnapshotProvider/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["ec2:CreateSnapshot","ec2:CreateVolume","ec2:DeleteSnapshot","ec2:DeleteVolume","ec2:DescribeSnapshots","ec2:DescribeVolumes"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"SnapshotProviderServiceRoleDefaultPolicyC4C3FE93","roles":[{"Ref":"SnapshotProviderServiceRoleA2DF3C0C"}]}}}}}}},"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/SnapshotProvider/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nconst { EC2Client, CreateVolumeCommand, CreateSnapshotCommand, DeleteVolumeCommand, DeleteSnapshotCommand, DescribeSnapshotsCommand, DescribeVolumesCommand } = require('@aws-sdk/client-ec2');\nconst ec2 = new EC2Client();\nconst sleep = (ms) => new Promise(r => setTimeout(r, ms));\nexports.handler = async (event) => {\n  if (event.RequestType === 'Delete') {\n    const snapshotId = event.PhysicalResourceId;\n    try { await ec2.send(new DeleteSnapshotCommand({ SnapshotId: snapshotId })); } catch (e) {}\n    return { PhysicalResourceId: snapshotId };\n  }\n  const az = event.ResourceProperties.AvailabilityZone;\n  const vol = await ec2.send(new CreateVolumeCommand({ AvailabilityZone: az, Size: 1, VolumeType: 'gp3' }));\n  // Wait for volume to be available\n  for (let i = 0; i < 60; i++) {\n    const desc = await ec2.send(new DescribeVolumesCommand({ VolumeIds: [vol.VolumeId] }));\n    if (desc.Volumes[0].State === 'available') break;\n    await sleep(5000);\n  }\n  const snap = await ec2.send(new CreateSnapshotCommand({ VolumeId: vol.VolumeId }));\n  // Wait for snapshot to complete\n  for (let i = 0; i < 60; i++) {\n    const desc = await ec2.send(new DescribeSnapshotsCommand({ SnapshotIds: [snap.SnapshotId] }));\n    if (desc.Snapshots[0].State === 'completed') break;\n    await sleep(10000);\n  }\n  await ec2.send(new DeleteVolumeCommand({ VolumeId: vol.VolumeId }));\n  return { PhysicalResourceId: snap.SnapshotId, Data: { SnapshotId: snap.SnapshotId } };\n};\n"},"handler":"index.handler","role":{"Fn::GetAtt":["SnapshotProviderServiceRoleA2DF3C0C","Arn"]},"runtime":"nodejs22.x","timeout":600}}},"LogGroup":{"id":"LogGroup","path":"volume-initialization-rate-stack/SnapshotProvider/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/SnapshotProvider/LogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":{"Fn::Join":["",["/aws/lambda/",{"Ref":"SnapshotProviderABC26AF9"}]]},"retentionInDays":731}}}}}}},"Provider":{"id":"Provider","path":"volume-initialization-rate-stack/Provider","constructInfo":{"fqn":"aws-cdk-lib.custom_resources.Provider","version":"0.0.0"},"children":{"framework-onEvent":{"id":"framework-onEvent","path":"volume-initialization-rate-stack/Provider/framework-onEvent","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"0.0.0"},"children":{"ServiceRole":{"id":"ServiceRole","path":"volume-initialization-rate-stack/Provider/framework-onEvent/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/Provider/framework-onEvent/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"volume-initialization-rate-stack/Provider/framework-onEvent/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/Provider/framework-onEvent/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":"lambda:InvokeFunction","Effect":"Allow","Resource":[{"Fn::GetAtt":["SnapshotProviderABC26AF9","Arn"]},{"Fn::Join":["",[{"Fn::GetAtt":["SnapshotProviderABC26AF9","Arn"]},":*"]]}]},{"Action":"lambda:GetFunction","Effect":"Allow","Resource":{"Fn::GetAtt":["SnapshotProviderABC26AF9","Arn"]}}],"Version":"2012-10-17"},"policyName":"ProviderframeworkonEventServiceRoleDefaultPolicy48CD2133","roles":[{"Ref":"ProviderframeworkonEventServiceRole9FF04296"}]}}}}}}},"Code":{"id":"Code","path":"volume-initialization-rate-stack/Provider/framework-onEvent/Code","constructInfo":{"fqn":"aws-cdk-lib.aws_s3_assets.Asset","version":"0.0.0"},"children":{"Stage":{"id":"Stage","path":"volume-initialization-rate-stack/Provider/framework-onEvent/Code/Stage","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"0.0.0"}},"AssetBucket":{"id":"AssetBucket","path":"volume-initialization-rate-stack/Provider/framework-onEvent/Code/AssetBucket","constructInfo":{"fqn":"aws-cdk-lib.aws_s3.BucketBase","version":"0.0.0"}}}},"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/Provider/framework-onEvent/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"s3Bucket":{"Fn::Sub":"cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"},"s3Key":"d14e70c8c1d5d6c32025ea07c4b9ed67be449820cf578659c9deb07160688c0e.zip"},"description":"AWS CDK resource provider framework - onEvent (volume-initialization-rate-stack/Provider)","environment":{"variables":{"USER_ON_EVENT_FUNCTION_ARN":{"Fn::GetAtt":["SnapshotProviderABC26AF9","Arn"]}}},"handler":"framework.onEvent","loggingConfig":{"logFormat":"JSON","applicationLogLevel":"FATAL"},"role":{"Fn::GetAtt":["ProviderframeworkonEventServiceRole9FF04296","Arn"]},"runtime":"nodejs22.x","timeout":900}}},"LogGroup":{"id":"LogGroup","path":"volume-initialization-rate-stack/Provider/framework-onEvent/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/Provider/framework-onEvent/LogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":{"Fn::Join":["",["/aws/lambda/",{"Ref":"ProviderframeworkonEvent83C1D0A7"}]]},"retentionInDays":731}}}}}}}}},"SnapshotResource":{"id":"SnapshotResource","path":"volume-initialization-rate-stack/SnapshotResource","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"0.0.0"},"children":{"Default":{"id":"Default","path":"volume-initialization-rate-stack/SnapshotResource/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"0.0.0"}}}},"Volume":{"id":"Volume","path":"volume-initialization-rate-stack/Volume","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.Volume","version":"0.0.0"},"children":{"Resource":{"id":"Resource","path":"volume-initialization-rate-stack/Volume/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnVolume","version":"0.0.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Volume","aws:cdk:cloudformation:props":{"availabilityZone":{"Fn::Select":[0,{"Fn::GetAZs":""}]},"multiAttachEnabled":false,"size":1,"snapshotId":{"Fn::GetAtt":["SnapshotResource","SnapshotId"]},"volumeInitializationRate":100,"volumeType":"gp3"}}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"volume-initialization-rate-stack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"0.0.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"volume-initialization-rate-stack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"0.0.0"}}}},"volume-initialization-rate-integ":{"id":"volume-initialization-rate-integ","path":"volume-initialization-rate-integ","constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTest","version":"0.0.0"},"children":{"DefaultTest":{"id":"DefaultTest","path":"volume-initialization-rate-integ/DefaultTest","constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTestCase","version":"0.0.0"},"children":{"Default":{"id":"Default","path":"volume-initialization-rate-integ/DefaultTest/Default","constructInfo":{"fqn":"constructs.Construct","version":"10.4.5"}},"DeployAssert":{"id":"DeployAssert","path":"volume-initialization-rate-integ/DefaultTest/DeployAssert","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"0.0.0"},"children":{"BootstrapVersion":{"id":"BootstrapVersion","path":"volume-initialization-rate-integ/DefaultTest/DeployAssert/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"0.0.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"volume-initialization-rate-integ/DefaultTest/DeployAssert/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"0.0.0"}}}}}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.5"}}}}}