{"version":"tree-0.1","tree":{"id":"App","path":"","children":{"integ-ecs-windows-core-ami":{"id":"integ-ecs-windows-core-ami","path":"integ-ecs-windows-core-ami","children":{"Vpc":{"id":"Vpc","path":"integ-ecs-windows-core-ami/Vpc","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/Vpc/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::VPC","aws:cdk:cloudformation:props":{"cidrBlock":"10.0.0.0/16","enableDnsHostnames":true,"enableDnsSupport":true,"instanceTenancy":"default","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"PublicSubnet1":{"id":"PublicSubnet1","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1","children":{"Subnet":{"id":"Subnet","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/Subnet","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Subnet","aws:cdk:cloudformation:props":{"availabilityZone":{"Fn::Select":[0,{"Fn::GetAZs":""}]},"cidrBlock":"10.0.0.0/18","mapPublicIpOnLaunch":true,"tags":[{"key":"aws-cdk:subnet-name","value":"Public"},{"key":"aws-cdk:subnet-type","value":"Public"},{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Acl":{"id":"Acl","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/Acl","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"RouteTable":{"id":"RouteTable","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/RouteTable","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::RouteTable","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"RouteTableAssociation":{"id":"RouteTableAssociation","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/RouteTableAssociation","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SubnetRouteTableAssociation","aws:cdk:cloudformation:props":{"routeTableId":{"Ref":"VpcPublicSubnet1RouteTable6C95E38E"},"subnetId":{"Ref":"VpcPublicSubnet1Subnet5C2D37C4"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultRoute":{"id":"DefaultRoute","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/DefaultRoute","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Route","aws:cdk:cloudformation:props":{"destinationCidrBlock":"0.0.0.0/0","gatewayId":{"Ref":"VpcIGWD7BA715C"},"routeTableId":{"Ref":"VpcPublicSubnet1RouteTable6C95E38E"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"EIP":{"id":"EIP","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/EIP","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::EIP","aws:cdk:cloudformation:props":{"domain":"vpc","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"NATGateway":{"id":"NATGateway","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1/NATGateway","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::NatGateway","aws:cdk:cloudformation:props":{"allocationId":{"Fn::GetAtt":["VpcPublicSubnet1EIPD7E02669","AllocationId"]},"subnetId":{"Ref":"VpcPublicSubnet1Subnet5C2D37C4"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet1"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}},"PublicSubnet2":{"id":"PublicSubnet2","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2","children":{"Subnet":{"id":"Subnet","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/Subnet","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Subnet","aws:cdk:cloudformation:props":{"availabilityZone":{"Fn::Select":[1,{"Fn::GetAZs":""}]},"cidrBlock":"10.0.64.0/18","mapPublicIpOnLaunch":true,"tags":[{"key":"aws-cdk:subnet-name","value":"Public"},{"key":"aws-cdk:subnet-type","value":"Public"},{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Acl":{"id":"Acl","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/Acl","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"RouteTable":{"id":"RouteTable","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/RouteTable","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::RouteTable","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"RouteTableAssociation":{"id":"RouteTableAssociation","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/RouteTableAssociation","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SubnetRouteTableAssociation","aws:cdk:cloudformation:props":{"routeTableId":{"Ref":"VpcPublicSubnet2RouteTable94F7E489"},"subnetId":{"Ref":"VpcPublicSubnet2Subnet691E08A3"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultRoute":{"id":"DefaultRoute","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/DefaultRoute","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Route","aws:cdk:cloudformation:props":{"destinationCidrBlock":"0.0.0.0/0","gatewayId":{"Ref":"VpcIGWD7BA715C"},"routeTableId":{"Ref":"VpcPublicSubnet2RouteTable94F7E489"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"EIP":{"id":"EIP","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/EIP","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::EIP","aws:cdk:cloudformation:props":{"domain":"vpc","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"NATGateway":{"id":"NATGateway","path":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2/NATGateway","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::NatGateway","aws:cdk:cloudformation:props":{"allocationId":{"Fn::GetAtt":["VpcPublicSubnet2EIP3C605A87","AllocationId"]},"subnetId":{"Ref":"VpcPublicSubnet2Subnet691E08A3"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PublicSubnet2"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}},"PrivateSubnet1":{"id":"PrivateSubnet1","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1","children":{"Subnet":{"id":"Subnet","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1/Subnet","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Subnet","aws:cdk:cloudformation:props":{"availabilityZone":{"Fn::Select":[0,{"Fn::GetAZs":""}]},"cidrBlock":"10.0.128.0/18","mapPublicIpOnLaunch":false,"tags":[{"key":"aws-cdk:subnet-name","value":"Private"},{"key":"aws-cdk:subnet-type","value":"Private"},{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Acl":{"id":"Acl","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1/Acl","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"RouteTable":{"id":"RouteTable","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1/RouteTable","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::RouteTable","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"RouteTableAssociation":{"id":"RouteTableAssociation","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1/RouteTableAssociation","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SubnetRouteTableAssociation","aws:cdk:cloudformation:props":{"routeTableId":{"Ref":"VpcPrivateSubnet1RouteTableB2C5B500"},"subnetId":{"Ref":"VpcPrivateSubnet1Subnet536B997A"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultRoute":{"id":"DefaultRoute","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet1/DefaultRoute","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Route","aws:cdk:cloudformation:props":{"destinationCidrBlock":"0.0.0.0/0","natGatewayId":{"Ref":"VpcPublicSubnet1NATGateway4D7517AA"},"routeTableId":{"Ref":"VpcPrivateSubnet1RouteTableB2C5B500"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*"]}},"PrivateSubnet2":{"id":"PrivateSubnet2","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2","children":{"Subnet":{"id":"Subnet","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2/Subnet","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Subnet","aws:cdk:cloudformation:props":{"availabilityZone":{"Fn::Select":[1,{"Fn::GetAZs":""}]},"cidrBlock":"10.0.192.0/18","mapPublicIpOnLaunch":false,"tags":[{"key":"aws-cdk:subnet-name","value":"Private"},{"key":"aws-cdk:subnet-type","value":"Private"},{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Acl":{"id":"Acl","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2/Acl","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"RouteTable":{"id":"RouteTable","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2/RouteTable","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::RouteTable","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"RouteTableAssociation":{"id":"RouteTableAssociation","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2/RouteTableAssociation","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SubnetRouteTableAssociation","aws:cdk:cloudformation:props":{"routeTableId":{"Ref":"VpcPrivateSubnet2RouteTableA678073B"},"subnetId":{"Ref":"VpcPrivateSubnet2Subnet3788AAA1"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultRoute":{"id":"DefaultRoute","path":"integ-ecs-windows-core-ami/Vpc/PrivateSubnet2/DefaultRoute","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Route","aws:cdk:cloudformation:props":{"destinationCidrBlock":"0.0.0.0/0","natGatewayId":{"Ref":"VpcPublicSubnet2NATGateway9182C01D"},"routeTableId":{"Ref":"VpcPrivateSubnet2RouteTableA678073B"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*"]}},"IGW":{"id":"IGW","path":"integ-ecs-windows-core-ami/Vpc/IGW","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::InternetGateway","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/Vpc"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"VPCGW":{"id":"VPCGW","path":"integ-ecs-windows-core-ami/Vpc/VPCGW","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::VPCGatewayAttachment","aws:cdk:cloudformation:props":{"internetGatewayId":{"Ref":"VpcIGWD7BA715C"},"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Cluster":{"id":"Cluster","path":"integ-ecs-windows-core-ami/Cluster","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/Cluster/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::Cluster","aws:cdk:cloudformation:props":{}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Cluster":{"id":"Cluster","path":"integ-ecs-windows-core-ami/Cluster/Cluster","attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::ClusterCapacityProviderAssociations","aws:cdk:cloudformation:props":{"capacityProviders":[{"Ref":"EC2CapacityProvider2022CoreA6E67593"},{"Ref":"EC2CapacityProvider2019Core6C94ECB3"}],"cluster":{"Ref":"ClusterEB0386A7"},"defaultCapacityProviderStrategy":[]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*"]}},"ASG-Win2022Core":{"id":"ASG-Win2022Core","path":"integ-ecs-windows-core-ami/ASG-Win2022Core","children":{"InstanceSecurityGroup":{"id":"InstanceSecurityGroup","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceSecurityGroup","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceSecurityGroup/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceSecurityGroup","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"InstanceRole":{"id":"InstanceRole","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceRole","children":{"ImportInstanceRole":{"id":"ImportInstanceRole","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceRole/ImportInstanceRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceRole/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceRole/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceRole/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["ecs:DeregisterContainerInstance","ecs:RegisterContainerInstance","ecs:Submit*"],"Effect":"Allow","Resource":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}},{"Action":["ecs:Poll","ecs:StartTelemetrySession"],"Condition":{"ArnEquals":{"ecs:cluster":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}},"Effect":"Allow","Resource":"*"},{"Action":["ecr:GetAuthorizationToken","ecs:DiscoverPollEndpoint","logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"ASGWin2022CoreInstanceRoleDefaultPolicyAFE03968","roles":[{"Ref":"ASGWin2022CoreInstanceRole260B30CC"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*"]}},"InstanceProfile":{"id":"InstanceProfile","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/InstanceProfile","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::InstanceProfile","aws:cdk:cloudformation:props":{"roles":[{"Ref":"ASGWin2022CoreInstanceRole260B30CC"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"ImportedInstanceProfile":{"id":"ImportedInstanceProfile","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/ImportedInstanceProfile","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"LaunchTemplate":{"id":"LaunchTemplate","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LaunchTemplate","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LaunchTemplate/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::LaunchTemplate","aws:cdk:cloudformation:props":{"launchTemplateData":{"iamInstanceProfile":{"arn":{"Fn::GetAtt":["ASGWin2022CoreInstanceProfile19561E87","Arn"]}},"imageId":{"Ref":"SsmParameterValueawsserviceamiwindowslatestWindowsServer2022EnglishCoreECSOptimizedimageidC96584B6F00A464EAD1953AFF4B05118Parameter"},"instanceType":"t2.micro","monitoring":{"enabled":false},"securityGroupIds":[{"Fn::GetAtt":["ASGWin2022CoreInstanceSecurityGroup9B150272","GroupId"]}],"tagSpecifications":[{"resourceType":"instance","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core/LaunchTemplate"}]},{"resourceType":"volume","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core/LaunchTemplate"}]}],"userData":{"Fn::Base64":{"Fn::Join":["",["<powershell>Remove-Item -Recurse C:\\ProgramData\\Amazon\\ECS\\Cache\nImport-Module ECSTools\n[Environment]::SetEnvironmentVariable(\"ECS_CLUSTER\", \"",{"Ref":"ClusterEB0386A7"},"\", \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_ENABLE_AWSLOGS_EXECUTIONROLE_OVERRIDE\", \"true\", \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_AVAILABLE_LOGGING_DRIVERS\", '[\"json-file\",\"awslogs\"]', \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_ENABLE_TASK_IAM_ROLE\", \"true\", \"Machine\")\nInitialize-ECSAgent -Cluster '",{"Ref":"ClusterEB0386A7"},"' -EnableTaskIAMRole</powershell>"]]}}},"tagSpecifications":[{"resourceType":"launch-template","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core/LaunchTemplate"}]}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"ASG":{"id":"ASG","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/ASG","attributes":{"aws:cdk:cloudformation:type":"AWS::AutoScaling::AutoScalingGroup","aws:cdk:cloudformation:props":{"launchTemplate":{"launchTemplateId":{"Ref":"ASGWin2022CoreLaunchTemplateEC9D9176"},"version":{"Fn::GetAtt":["ASGWin2022CoreLaunchTemplateEC9D9176","LatestVersionNumber"]}},"maxSize":"1","minSize":"0","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core","propagateAtLaunch":true}],"vpcZoneIdentifier":[{"Ref":"VpcPrivateSubnet1Subnet536B997A"},{"Ref":"VpcPrivateSubnet2Subnet3788AAA1"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DrainECSHook":{"id":"DrainECSHook","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook","children":{"Function":{"id":"Function","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function","children":{"ServiceRole":{"id":"ServiceRole","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/ServiceRole","children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/ServiceRole/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/ServiceRole/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/ServiceRole/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["ec2:DescribeHosts","ec2:DescribeInstanceAttribute","ec2:DescribeInstanceStatus","ec2:DescribeInstances"],"Effect":"Allow","Resource":"*"},{"Action":"autoscaling:CompleteLifecycleAction","Effect":"Allow","Resource":{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":autoscaling:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":autoScalingGroup:*:autoScalingGroupName/",{"Ref":"ASGWin2022CoreASGBB924878"}]]}},{"Action":["ecs:DescribeContainerInstances","ecs:DescribeTasks","ecs:ListTasks","ecs:UpdateContainerInstancesState"],"Condition":{"ArnEquals":{"ecs:cluster":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}},"Effect":"Allow","Resource":"*"},{"Action":["ecs:ListContainerInstances","ecs:SubmitContainerStateChange","ecs:SubmitTaskStateChange"],"Effect":"Allow","Resource":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}],"Version":"2012-10-17"},"policyName":"ASGWin2022CoreDrainECSHookFunctionServiceRoleDefaultPolicy91DA5587","roles":[{"Ref":"ASGWin2022CoreDrainECSHookFunctionServiceRoleDEB0FB03"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"import boto3, json, os, time\n\necs = boto3.client('ecs')\nautoscaling = boto3.client('autoscaling')\n\n\ndef lambda_handler(event, context):\n  print(json.dumps(dict(event, ResponseURL='...')))\n  cluster = os.environ['CLUSTER']\n  snsTopicArn = event['Records'][0]['Sns']['TopicArn']\n  lifecycle_event = json.loads(event['Records'][0]['Sns']['Message'])\n  instance_id = lifecycle_event.get('EC2InstanceId')\n  if not instance_id:\n    print('Got event without EC2InstanceId: %s', json.dumps(dict(event, ResponseURL='...')))\n    return\n\n  instance_arn = container_instance_arn(cluster, instance_id)\n  print('Instance %s has container instance ARN %s' % (lifecycle_event['EC2InstanceId'], instance_arn))\n\n  if not instance_arn:\n    return\n\n  task_arns = container_instance_task_arns(cluster, instance_arn)\n\n  if task_arns:\n    print('Instance ARN %s has task ARNs %s' % (instance_arn, ', '.join(task_arns)))\n\n  while has_tasks(cluster, instance_arn, task_arns):\n    time.sleep(10)\n\n  try:\n    print('Terminating instance %s' % instance_id)\n    autoscaling.complete_lifecycle_action(\n        LifecycleActionResult='CONTINUE',\n        **pick(lifecycle_event, 'LifecycleHookName', 'LifecycleActionToken', 'AutoScalingGroupName'))\n  except Exception as e:\n    # Lifecycle action may have already completed.\n    print(str(e))\n\n\ndef container_instance_arn(cluster, instance_id):\n  \"\"\"Turn an instance ID into a container instance ARN.\"\"\"\n  arns = ecs.list_container_instances(cluster=cluster, filter='ec2InstanceId==' + instance_id)['containerInstanceArns']\n  if not arns:\n    return None\n  return arns[0]\n\ndef container_instance_task_arns(cluster, instance_arn):\n  \"\"\"Fetch tasks for a container instance ARN.\"\"\"\n  arns = ecs.list_tasks(cluster=cluster, containerInstance=instance_arn)['taskArns']\n  return arns\n\ndef has_tasks(cluster, instance_arn, task_arns):\n  \"\"\"Return True if the instance is running tasks for the given cluster.\"\"\"\n  instances = ecs.describe_container_instances(cluster=cluster, containerInstances=[instance_arn])['containerInstances']\n  if not instances:\n    return False\n  instance = instances[0]\n\n  if instance['status'] == 'ACTIVE':\n    # Start draining, then try again later\n    set_container_instance_to_draining(cluster, instance_arn)\n    return True\n\n  task_count = None\n\n  if task_arns:\n    # Fetch details for tasks running on the container instance\n    tasks = ecs.describe_tasks(cluster=cluster, tasks=task_arns)['tasks']\n    if tasks:\n      # Consider any non-stopped tasks as running\n      task_count = sum(task['lastStatus'] != 'STOPPED' for task in tasks) + instance['pendingTasksCount']\n\n  if not task_count:\n    # Fallback to instance task counts if detailed task information is unavailable\n    task_count = instance['runningTasksCount'] + instance['pendingTasksCount']\n\n  print('Instance %s has %s tasks' % (instance_arn, task_count))\n\n  return task_count > 0\n\ndef set_container_instance_to_draining(cluster, instance_arn):\n  ecs.update_container_instances_state(\n      cluster=cluster,\n      containerInstances=[instance_arn], status='DRAINING')\n\n\ndef pick(dct, *keys):\n  \"\"\"Pick a subset of a dict.\"\"\"\n  return {k: v for k, v in dct.items() if k in keys}\n"},"environment":{"variables":{"CLUSTER":{"Ref":"ClusterEB0386A7"}}},"handler":"index.lambda_handler","role":{"Fn::GetAtt":["ASGWin2022CoreDrainECSHookFunctionServiceRoleDEB0FB03","Arn"]},"runtime":"python3.9","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}],"timeout":310}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"AllowInvoke:integecswindowscoreamiASGWin2022CoreLifecycleHookDrainHookTopicE3196F76":{"id":"AllowInvoke:integecswindowscoreamiASGWin2022CoreLifecycleHookDrainHookTopicE3196F76","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/AllowInvoke:integecswindowscoreamiASGWin2022CoreLifecycleHookDrainHookTopicE3196F76","attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Permission","aws:cdk:cloudformation:props":{"action":"lambda:InvokeFunction","functionName":{"Fn::GetAtt":["ASGWin2022CoreDrainECSHookFunction9D903E21","Arn"]},"principal":"sns.amazonaws.com","sourceArn":{"Ref":"ASGWin2022CoreLifecycleHookDrainHookTopicFA049579"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Topic":{"id":"Topic","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/Topic","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/DrainECSHook/Function/Topic/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Subscription","aws:cdk:cloudformation:props":{"endpoint":{"Fn::GetAtt":["ASGWin2022CoreDrainECSHookFunction9D903E21","Arn"]},"protocol":"lambda","topicArn":{"Ref":"ASGWin2022CoreLifecycleHookDrainHookTopicFA049579"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"LifecycleHookDrainHook":{"id":"LifecycleHookDrainHook","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook","children":{"Topic":{"id":"Topic","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Topic","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Topic/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Topic","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Role":{"id":"Role","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Role","children":{"ImportRole":{"id":"ImportRole","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Role/ImportRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Role/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"autoscaling.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2022Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Role/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Role/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":"sns:Publish","Effect":"Allow","Resource":{"Ref":"ASGWin2022CoreLifecycleHookDrainHookTopicFA049579"}}],"Version":"2012-10-17"},"policyName":"ASGWin2022CoreLifecycleHookDrainHookRoleDefaultPolicyEC5E58D9","roles":[{"Ref":"ASGWin2022CoreLifecycleHookDrainHookRole067A0289"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2022Core/LifecycleHookDrainHook/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::AutoScaling::LifecycleHook","aws:cdk:cloudformation:props":{"autoScalingGroupName":{"Ref":"ASGWin2022CoreASGBB924878"},"defaultResult":"CONTINUE","heartbeatTimeout":300,"lifecycleTransition":"autoscaling:EC2_INSTANCE_TERMINATING","notificationTargetArn":{"Ref":"ASGWin2022CoreLifecycleHookDrainHookTopicFA049579"},"roleArn":{"Fn::GetAtt":["ASGWin2022CoreLifecycleHookDrainHookRole067A0289","Arn"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*","*","*","*"]}},"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter":{"id":"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","path":"integ-ecs-windows-core-ami/SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118":{"id":"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118","path":"integ-ecs-windows-core-ami/SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2022-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"EC2CapacityProvider2022Core":{"id":"EC2CapacityProvider2022Core","path":"integ-ecs-windows-core-ami/EC2CapacityProvider2022Core","children":{"EC2CapacityProvider2022Core":{"id":"EC2CapacityProvider2022Core","path":"integ-ecs-windows-core-ami/EC2CapacityProvider2022Core/EC2CapacityProvider2022Core","attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::CapacityProvider","aws:cdk:cloudformation:props":{"autoScalingGroupProvider":{"autoScalingGroupArn":{"Ref":"ASGWin2022CoreASGBB924878"},"managedScaling":{"status":"ENABLED","targetCapacity":100},"managedTerminationProtection":"DISABLED"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"ASG-Win2019Core":{"id":"ASG-Win2019Core","path":"integ-ecs-windows-core-ami/ASG-Win2019Core","children":{"InstanceSecurityGroup":{"id":"InstanceSecurityGroup","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceSecurityGroup","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceSecurityGroup/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceSecurityGroup","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}],"vpcId":{"Ref":"Vpc8378EB38"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"InstanceRole":{"id":"InstanceRole","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceRole","children":{"ImportInstanceRole":{"id":"ImportInstanceRole","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceRole/ImportInstanceRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceRole/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceRole/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceRole/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["ecs:DeregisterContainerInstance","ecs:RegisterContainerInstance","ecs:Submit*"],"Effect":"Allow","Resource":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}},{"Action":["ecs:Poll","ecs:StartTelemetrySession"],"Condition":{"ArnEquals":{"ecs:cluster":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}},"Effect":"Allow","Resource":"*"},{"Action":["ecr:GetAuthorizationToken","ecs:DiscoverPollEndpoint","logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"ASGWin2019CoreInstanceRoleDefaultPolicy93C292B8","roles":[{"Ref":"ASGWin2019CoreInstanceRole789AFEC5"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*"]}},"InstanceProfile":{"id":"InstanceProfile","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/InstanceProfile","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::InstanceProfile","aws:cdk:cloudformation:props":{"roles":[{"Ref":"ASGWin2019CoreInstanceRole789AFEC5"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"ImportedInstanceProfile":{"id":"ImportedInstanceProfile","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/ImportedInstanceProfile","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"LaunchTemplate":{"id":"LaunchTemplate","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LaunchTemplate","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LaunchTemplate/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::LaunchTemplate","aws:cdk:cloudformation:props":{"launchTemplateData":{"iamInstanceProfile":{"arn":{"Fn::GetAtt":["ASGWin2019CoreInstanceProfileBF14CDCB","Arn"]}},"imageId":{"Ref":"SsmParameterValueawsserviceamiwindowslatestWindowsServer2019EnglishCoreECSOptimizedimageidC96584B6F00A464EAD1953AFF4B05118Parameter"},"instanceType":"t2.micro","monitoring":{"enabled":false},"securityGroupIds":[{"Fn::GetAtt":["ASGWin2019CoreInstanceSecurityGroup98D7D0D0","GroupId"]}],"tagSpecifications":[{"resourceType":"instance","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core/LaunchTemplate"}]},{"resourceType":"volume","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core/LaunchTemplate"}]}],"userData":{"Fn::Base64":{"Fn::Join":["",["<powershell>Remove-Item -Recurse C:\\ProgramData\\Amazon\\ECS\\Cache\nImport-Module ECSTools\n[Environment]::SetEnvironmentVariable(\"ECS_CLUSTER\", \"",{"Ref":"ClusterEB0386A7"},"\", \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_ENABLE_AWSLOGS_EXECUTIONROLE_OVERRIDE\", \"true\", \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_AVAILABLE_LOGGING_DRIVERS\", '[\"json-file\",\"awslogs\"]', \"Machine\")\n[Environment]::SetEnvironmentVariable(\"ECS_ENABLE_TASK_IAM_ROLE\", \"true\", \"Machine\")\nInitialize-ECSAgent -Cluster '",{"Ref":"ClusterEB0386A7"},"' -EnableTaskIAMRole</powershell>"]]}}},"tagSpecifications":[{"resourceType":"launch-template","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core/LaunchTemplate"}]}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"ASG":{"id":"ASG","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/ASG","attributes":{"aws:cdk:cloudformation:type":"AWS::AutoScaling::AutoScalingGroup","aws:cdk:cloudformation:props":{"launchTemplate":{"launchTemplateId":{"Ref":"ASGWin2019CoreLaunchTemplate9CDB8014"},"version":{"Fn::GetAtt":["ASGWin2019CoreLaunchTemplate9CDB8014","LatestVersionNumber"]}},"maxSize":"1","minSize":"0","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core","propagateAtLaunch":true}],"vpcZoneIdentifier":[{"Ref":"VpcPrivateSubnet1Subnet536B997A"},{"Ref":"VpcPrivateSubnet2Subnet3788AAA1"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DrainECSHook":{"id":"DrainECSHook","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook","children":{"Function":{"id":"Function","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function","children":{"ServiceRole":{"id":"ServiceRole","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/ServiceRole","children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/ServiceRole/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}],"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/ServiceRole/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/ServiceRole/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["ec2:DescribeHosts","ec2:DescribeInstanceAttribute","ec2:DescribeInstanceStatus","ec2:DescribeInstances"],"Effect":"Allow","Resource":"*"},{"Action":"autoscaling:CompleteLifecycleAction","Effect":"Allow","Resource":{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":autoscaling:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":autoScalingGroup:*:autoScalingGroupName/",{"Ref":"ASGWin2019CoreASG09FBC80E"}]]}},{"Action":["ecs:DescribeContainerInstances","ecs:DescribeTasks","ecs:ListTasks","ecs:UpdateContainerInstancesState"],"Condition":{"ArnEquals":{"ecs:cluster":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}},"Effect":"Allow","Resource":"*"},{"Action":["ecs:ListContainerInstances","ecs:SubmitContainerStateChange","ecs:SubmitTaskStateChange"],"Effect":"Allow","Resource":{"Fn::GetAtt":["ClusterEB0386A7","Arn"]}}],"Version":"2012-10-17"},"policyName":"ASGWin2019CoreDrainECSHookFunctionServiceRoleDefaultPolicy852E2B97","roles":[{"Ref":"ASGWin2019CoreDrainECSHookFunctionServiceRole74692A98"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"import boto3, json, os, time\n\necs = boto3.client('ecs')\nautoscaling = boto3.client('autoscaling')\n\n\ndef lambda_handler(event, context):\n  print(json.dumps(dict(event, ResponseURL='...')))\n  cluster = os.environ['CLUSTER']\n  snsTopicArn = event['Records'][0]['Sns']['TopicArn']\n  lifecycle_event = json.loads(event['Records'][0]['Sns']['Message'])\n  instance_id = lifecycle_event.get('EC2InstanceId')\n  if not instance_id:\n    print('Got event without EC2InstanceId: %s', json.dumps(dict(event, ResponseURL='...')))\n    return\n\n  instance_arn = container_instance_arn(cluster, instance_id)\n  print('Instance %s has container instance ARN %s' % (lifecycle_event['EC2InstanceId'], instance_arn))\n\n  if not instance_arn:\n    return\n\n  task_arns = container_instance_task_arns(cluster, instance_arn)\n\n  if task_arns:\n    print('Instance ARN %s has task ARNs %s' % (instance_arn, ', '.join(task_arns)))\n\n  while has_tasks(cluster, instance_arn, task_arns):\n    time.sleep(10)\n\n  try:\n    print('Terminating instance %s' % instance_id)\n    autoscaling.complete_lifecycle_action(\n        LifecycleActionResult='CONTINUE',\n        **pick(lifecycle_event, 'LifecycleHookName', 'LifecycleActionToken', 'AutoScalingGroupName'))\n  except Exception as e:\n    # Lifecycle action may have already completed.\n    print(str(e))\n\n\ndef container_instance_arn(cluster, instance_id):\n  \"\"\"Turn an instance ID into a container instance ARN.\"\"\"\n  arns = ecs.list_container_instances(cluster=cluster, filter='ec2InstanceId==' + instance_id)['containerInstanceArns']\n  if not arns:\n    return None\n  return arns[0]\n\ndef container_instance_task_arns(cluster, instance_arn):\n  \"\"\"Fetch tasks for a container instance ARN.\"\"\"\n  arns = ecs.list_tasks(cluster=cluster, containerInstance=instance_arn)['taskArns']\n  return arns\n\ndef has_tasks(cluster, instance_arn, task_arns):\n  \"\"\"Return True if the instance is running tasks for the given cluster.\"\"\"\n  instances = ecs.describe_container_instances(cluster=cluster, containerInstances=[instance_arn])['containerInstances']\n  if not instances:\n    return False\n  instance = instances[0]\n\n  if instance['status'] == 'ACTIVE':\n    # Start draining, then try again later\n    set_container_instance_to_draining(cluster, instance_arn)\n    return True\n\n  task_count = None\n\n  if task_arns:\n    # Fetch details for tasks running on the container instance\n    tasks = ecs.describe_tasks(cluster=cluster, tasks=task_arns)['tasks']\n    if tasks:\n      # Consider any non-stopped tasks as running\n      task_count = sum(task['lastStatus'] != 'STOPPED' for task in tasks) + instance['pendingTasksCount']\n\n  if not task_count:\n    # Fallback to instance task counts if detailed task information is unavailable\n    task_count = instance['runningTasksCount'] + instance['pendingTasksCount']\n\n  print('Instance %s has %s tasks' % (instance_arn, task_count))\n\n  return task_count > 0\n\ndef set_container_instance_to_draining(cluster, instance_arn):\n  ecs.update_container_instances_state(\n      cluster=cluster,\n      containerInstances=[instance_arn], status='DRAINING')\n\n\ndef pick(dct, *keys):\n  \"\"\"Pick a subset of a dict.\"\"\"\n  return {k: v for k, v in dct.items() if k in keys}\n"},"environment":{"variables":{"CLUSTER":{"Ref":"ClusterEB0386A7"}}},"handler":"index.lambda_handler","role":{"Fn::GetAtt":["ASGWin2019CoreDrainECSHookFunctionServiceRole74692A98","Arn"]},"runtime":"python3.9","tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}],"timeout":310}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"AllowInvoke:integecswindowscoreamiASGWin2019CoreLifecycleHookDrainHookTopic3026395C":{"id":"AllowInvoke:integecswindowscoreamiASGWin2019CoreLifecycleHookDrainHookTopic3026395C","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/AllowInvoke:integecswindowscoreamiASGWin2019CoreLifecycleHookDrainHookTopic3026395C","attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Permission","aws:cdk:cloudformation:props":{"action":"lambda:InvokeFunction","functionName":{"Fn::GetAtt":["ASGWin2019CoreDrainECSHookFunction17A7DCA1","Arn"]},"principal":"sns.amazonaws.com","sourceArn":{"Ref":"ASGWin2019CoreLifecycleHookDrainHookTopicBBBEFED1"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Topic":{"id":"Topic","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/Topic","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/DrainECSHook/Function/Topic/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Subscription","aws:cdk:cloudformation:props":{"endpoint":{"Fn::GetAtt":["ASGWin2019CoreDrainECSHookFunction17A7DCA1","Arn"]},"protocol":"lambda","topicArn":{"Ref":"ASGWin2019CoreLifecycleHookDrainHookTopicBBBEFED1"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"LifecycleHookDrainHook":{"id":"LifecycleHookDrainHook","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook","children":{"Topic":{"id":"Topic","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Topic","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Topic/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Topic","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Role":{"id":"Role","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Role","children":{"ImportRole":{"id":"ImportRole","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Role/ImportRole","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Role/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"autoscaling.amazonaws.com"}}],"Version":"2012-10-17"},"tags":[{"key":"Name","value":"integ-ecs-windows-core-ami/ASG-Win2019Core"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DefaultPolicy":{"id":"DefaultPolicy","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Role/DefaultPolicy","children":{"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Role/DefaultPolicy/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":"sns:Publish","Effect":"Allow","Resource":{"Ref":"ASGWin2019CoreLifecycleHookDrainHookTopicBBBEFED1"}}],"Version":"2012-10-17"},"policyName":"ASGWin2019CoreLifecycleHookDrainHookRoleDefaultPolicy2CBAED41","roles":[{"Ref":"ASGWin2019CoreLifecycleHookDrainHookRole0BD06247"}]}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*"]}},"Resource":{"id":"Resource","path":"integ-ecs-windows-core-ami/ASG-Win2019Core/LifecycleHookDrainHook/Resource","attributes":{"aws:cdk:cloudformation:type":"AWS::AutoScaling::LifecycleHook","aws:cdk:cloudformation:props":{"autoScalingGroupName":{"Ref":"ASGWin2019CoreASG09FBC80E"},"defaultResult":"CONTINUE","heartbeatTimeout":300,"lifecycleTransition":"autoscaling:EC2_INSTANCE_TERMINATING","notificationTargetArn":{"Ref":"ASGWin2019CoreLifecycleHookDrainHookTopicBBBEFED1"},"roleArn":{"Fn::GetAtt":["ASGWin2019CoreLifecycleHookDrainHookRole0BD06247","Arn"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*"]}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":["*","*","*","*","*","*","*","*","*","*","*"]}},"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter":{"id":"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","path":"integ-ecs-windows-core-ami/SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118":{"id":"SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118","path":"integ-ecs-windows-core-ami/SsmParameterValue:--aws--service--ami-windows-latest--Windows_Server-2019-English-Core-ECS_Optimized--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2","metadata":[]}},"EC2CapacityProvider2019Core":{"id":"EC2CapacityProvider2019Core","path":"integ-ecs-windows-core-ami/EC2CapacityProvider2019Core","children":{"EC2CapacityProvider2019Core":{"id":"EC2CapacityProvider2019Core","path":"integ-ecs-windows-core-ami/EC2CapacityProvider2019Core/EC2CapacityProvider2019Core","attributes":{"aws:cdk:cloudformation:type":"AWS::ECS::CapacityProvider","aws:cdk:cloudformation:props":{"autoScalingGroupProvider":{"autoScalingGroupArn":{"Ref":"ASGWin2019CoreASG09FBC80E"},"managedScaling":{"status":"ENABLED","targetCapacity":100},"managedTerminationProtection":"DISABLED"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"BootstrapVersion":{"id":"BootstrapVersion","path":"integ-ecs-windows-core-ami/BootstrapVersion","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"integ-ecs-windows-core-ami/CheckBootstrapVersion","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"ClusterWindowsCoreAmi":{"id":"ClusterWindowsCoreAmi","path":"ClusterWindowsCoreAmi","children":{"DefaultTest":{"id":"DefaultTest","path":"ClusterWindowsCoreAmi/DefaultTest","children":{"Default":{"id":"Default","path":"ClusterWindowsCoreAmi/DefaultTest/Default","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DeployAssert":{"id":"DeployAssert","path":"ClusterWindowsCoreAmi/DefaultTest/DeployAssert","children":{"BootstrapVersion":{"id":"BootstrapVersion","path":"ClusterWindowsCoreAmi/DefaultTest/DeployAssert/BootstrapVersion","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"ClusterWindowsCoreAmi/DefaultTest/DeployAssert/CheckBootstrapVersion","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTestCase","version":"0.0.0"}}},"constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTest","version":"0.0.0"}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}},"constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}}