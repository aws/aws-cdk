#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ec2 = require("aws-cdk-lib/aws-ec2");
const cdk = require("aws-cdk-lib");
const elbv2 = require("aws-cdk-lib/aws-elasticloadbalancingv2");
/* IPv6 workaround found here: https://github.com/aws/aws-cdk/issues/894 */
const valueOrDie = (value, err) => {
    if (value === undefined) {
        throw err;
    }
    return value;
};
/**
 * Integration test to deployability and use of dualstack ALB. Creates an ALB
 * with dualstack ipAddresType and an ipv6Block to add to VPC subnets. Main
 * test is for the inclusion of default IPv6 ingress rule.
 *
 * Stack Verification steps:
 * VPC is created with subnets that allow for IPv6 connection and then dualstack
 * ALB attaches a listener with dualstack that defaults IPv4/IPv6 ingress rule.
 *
 */
const app = new cdk.App();
const stack = new cdk.Stack(app, 'aws-cdk-elbv2-integ');
const vpc = new ec2.Vpc(stack, 'VPC', {
    maxAzs: 2,
});
const ipv6Block = new ec2.CfnVPCCidrBlock(stack, 'IPv6_Block', {
    vpcId: vpc.vpcId,
    amazonProvidedIpv6CidrBlock: true,
});
// Get the vpc's internet gateway so we can create default routes for the
// public subnets.
const internetGateway = valueOrDie(vpc.node.children.find(c => c instanceof ec2.CfnInternetGateway), new Error('Couldnt find an internet gateway'));
const lb = new elbv2.ApplicationLoadBalancer(stack, 'LB', {
    vpc,
    ipAddressType: elbv2.IpAddressType.DUAL_STACK,
    internetFacing: true,
});
const listener = lb.addListener('Listener', {
    port: 80,
});
const group1 = listener.addTargets('Target', {
    port: 80,
    targets: [new elbv2.IpTarget('10.0.128.6')],
});
const group2 = listener.addTargets('ConditionalTarget', {
    priority: 10,
    hostHeader: 'example.com',
    port: 80,
    targets: [new elbv2.IpTarget('10.0.128.5')],
});
vpc.publicSubnets.forEach((subnet, idx) => {
    // Add a default ipv6 route to the subnet's route table.
    const unboxedSubnet = subnet;
    unboxedSubnet.addRoute('IPv6Default', {
        routerId: internetGateway.ref,
        routerType: ec2.RouterType.GATEWAY,
        destinationIpv6CidrBlock: '::/0',
    });
    // Find a CfnSubnet (raw cloudformation resources) child to the public
    // subnet nodes.
    const cfnSubnet = valueOrDie(subnet.node.children.find(c => c instanceof ec2.CfnSubnet), new Error('Couldnt find a CfnSubnet'));
    // Use the intrinsic Fn::Cidr CloudFormation function on the VPC's
    // first IPv6 block to determine ipv6 /64 cidrs for each subnet as
    // a function of the public subnet's index.
    const vpcCidrBlock = cdk.Fn.select(0, vpc.vpcIpv6CidrBlocks);
    const ipv6Cidrs = cdk.Fn.cidr(vpcCidrBlock, vpc.publicSubnets.length, '64');
    cfnSubnet.ipv6CidrBlock = cdk.Fn.select(idx, ipv6Cidrs);
    // The subnet depends on the ipv6 cidr being allocated.
    cfnSubnet.addDependency(ipv6Block);
    group1.node.addDependency(subnet);
    group2.node.addDependency(subnet);
});
listener.addAction('action1', {
    priority: 1,
    conditions: [
        elbv2.ListenerCondition.hostHeaders(['example.com']),
    ],
    action: elbv2.ListenerAction.fixedResponse(200, { messageBody: 'success' }),
});
group1.metricTargetResponseTime().createAlarm(stack, 'ResponseTimeHigh1', {
    threshold: 5,
    evaluationPeriods: 2,
});
group2.metricTargetResponseTime().createAlarm(stack, 'ResponseTimeHigh2', {
    threshold: 5,
    evaluationPeriods: 2,
});
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcuYWxiLmR1YWxzdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImludGVnLmFsYi5kdWFsc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMkNBQTJDO0FBQzNDLG1DQUFtQztBQUVuQyxnRUFBZ0U7QUFFaEUsMkVBQTJFO0FBQzNFLE1BQU0sVUFBVSxHQUFHLENBQXFCLEtBQW9CLEVBQUUsR0FBVSxFQUFLLEVBQUU7SUFDN0UsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO1FBQUUsTUFBTSxHQUFHLENBQUM7S0FBRTtJQUN2QyxPQUFPLEtBQVUsQ0FBQztBQUNwQixDQUFDLENBQUM7QUFFRjs7Ozs7Ozs7O0dBU0c7QUFDSCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLHFCQUFxQixDQUFDLENBQUM7QUFFeEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUU7SUFDcEMsTUFBTSxFQUFFLENBQUM7Q0FDVixDQUFDLENBQUM7QUFFSCxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQ3ZDLEtBQUssRUFDTCxZQUFZLEVBQ1o7SUFDRSxLQUFLLEVBQUUsR0FBRyxDQUFDLEtBQUs7SUFDaEIsMkJBQTJCLEVBQUUsSUFBSTtDQUNsQyxDQUNGLENBQUM7QUFFRix5RUFBeUU7QUFDekUsa0JBQWtCO0FBQ2xCLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxFQUNoRSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUM5QyxDQUFDO0FBR0YsTUFB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bUIsRUFBRTtJQUN4RSxTQUFTLEVBQUUsQ0FBQztJQUNaLGlCQUFpQixFQUFFLENBQUM7Q0FDckIsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLHdCQUF3QixFQUFFLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRTtJQUN4RSxTQUFTLEVBQUUsQ0FBQztJQUNaLGlCQUFpQixFQUFFLENBQUM7Q0FDckIsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IElDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGVsYnYyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyJztcblxuLyogSVB2NiB3b3JrYXJvdW5kIGZvdW5kIGhlcmU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9pc3N1ZXMvODk0ICovXG5jb25zdCB2YWx1ZU9yRGllID0gPFQsIEMgZXh0ZW5kcyBUID0gVD4odmFsdWU6IFQgfCB1bmRlZmluZWQsIGVycjogRXJyb3IpOiBDID0+IHtcbiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsgdGhyb3cgZXJyOyB9XG4gIHJldHVybiB2YWx1ZSBhcyBDO1xufTtcblxuLyoqXG4gKiBJbnRlZ3JhdGlvbiB0ZXN0IHRvIGRlcGxveWFiaWxpdHkgYW5kIHVzZSBvZiBkdWFsc3RhY2sgQUxCLiBDcmVhdGVzIGFuIEFMQlxuICogd2l0aCBkdWFsc3RhY2sgaXBBZGRyZXNUeXBlIGFuZCBhbiBpcHY2QmxvY2sgdG8gYWRkIHRvIFZQQyBzdWJuZXRzLiBNYWluXG4gKiB0ZXN0IGlzIGZvciB0aGUgaW5jbHVzaW9uIG9mIGRlZmF1bHQgSVB2NiBpbmdyZXNzIHJ1bGUuXG4gKlxuICogU3RhY2sgVmVyaWZpY2F0aW9uIHN0ZXBzOlxuICogVlBDIGlzIGNyZWF0ZWQgd2l0aCBzdWJuZXRzIHRoYXQgYWxsb3cgZm9yIElQdjYgY29ubmVjdGlvbiBhbmQgdGhlbiBkdWFsc3RhY2tcbiAqIEFMQiBhdHRhY2hlcyBhIGxpc3RlbmVyIHdpdGggZHVhbHN0YWNrIHRoYXQgZGVmYXVsdHMgSVB2NC9JUHY2IGluZ3Jlc3MgcnVsZS5cbiAqXG4gKi9cbmNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG5jb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soYXBwLCAnYXdzLWNkay1lbGJ2Mi1pbnRlZycpO1xuXG5jb25zdCB2cGMgPSBuZXcgZWMyLlZwYyhzdGFjaywgJ1ZQQycsIHtcbiAgbWF4QXpzOiAyLFxufSk7XG5cbmNvbnN0IGlwdjZCbG9jayA9IG5ldyBlYzIuQ2ZuVlBDQ2lkckJsb2NrKFxuICBzdGFjayxcbiAgJ0lQdjZfQmxvY2snLFxuICB7XG4gICAgdnBjSWQ6IHZwYy52cGNJZCxcbiAgICBhbWF6b25Qcm92aWRlZElwdjZDaWRyQmxvY2s6IHRydWUsXG4gIH0sXG4pO1xuXG4vLyBHZXQgdGhlIHZwYydzIGludGVybmV0IGdhdGV3YXkgc28gd2UgY2FuIGNyZWF0ZSBkZWZhdWx0IHJvdXRlcyBmb3IgdGhlXG4vLyBwdWJsaWMgc3VibmV0cy5cbmNvbnN0IGludGVybmV0R2F0ZXdheSA9IHZhbHVlT3JEaWU8SUNvbnN0cnVjdCwgZWMyLkNmbkludGVybmV0R2F0ZXdheT4oXG4gIHZwYy5ub2RlLmNoaWxkcmVuLmZpbmQoYyA9PiBjIGluc3RhbmNlb2YgZWMyLkNmbkludGVybmV0R2F0ZXdheSksXG4gIG5ldyBFcnJvcignQ291bGRudCBmaW5kIGFuIGludGVybmV0IGdhdGV3YXknKSxcbik7XG5cblxuY29uc3QgbGIgPSBuZXcgZWxidjIuQXBwbGljYXRpb25Mb2FkQmFsYW5jZXIoc3RhY2ssICdMQicsIHtcbiAgdnBjLFxuICBpcEFkZHJlc3NUeXBlOiBlbGJ2Mi5JcEFkZHJlc3NUeXBlLkRVQUxfU1RBQ0ssXG4gIGludGVybmV0RmFjaW5nOiB0cnVlLFxufSk7XG5cbmNvbnN0IGxpc3RlbmVyID0gbGIuYWRkTGlzdGVuZXIoJ0xpc3RlbmVyJywge1xuICBwb3J0OiA4MCxcbn0pO1xuXG5jb25zdCBncm91cDEgPSBsaXN0ZW5lci5hZGRUYXJnZXRzKCdUYXJnZXQnLCB7XG4gIHBvcnQ6IDgwLFxuICB0YXJnZXRzOiBbbmV3IGVsYnYyLklwVGFyZ2V0KCcxMC4wLjEyOC42JyldLFxufSk7XG5cbmNvbnN0IGdyb3VwMiA9IGxpc3RlbmVyLmFkZFRhcmdldHMoJ0NvbmRpdGlvbmFsVGFyZ2V0Jywge1xuICBwcmlvcml0eTogMTAsXG4gIGhvc3RIZWFkZXI6ICdleGFtcGxlLmNvbScsXG4gIHBvcnQ6IDgwLFxuICB0YXJnZXRzOiBbbmV3IGVsYnYyLklwVGFyZ2V0KCcxMC4wLjEyOC41JyldLFxufSk7XG5cbnZwYy5wdWJsaWNTdWJuZXRzLmZvckVhY2goKHN1Ym5ldCwgaWR4KSA9PiB7XG4gIC8vIEFkZCBhIGRlZmF1bHQgaXB2NiByb3V0ZSB0byB0aGUgc3VibmV0J3Mgcm91dGUgdGFibGUuXG4gIGNvbnN0IHVuYm94ZWRTdWJuZXQgPSBzdWJuZXQgYXMgZWMyLlN1Ym5ldDtcbiAgdW5ib3hlZFN1Ym5ldC5hZGRSb3V0ZSgnSVB2NkRlZmF1bHQnLCB7XG4gICAgcm91dGVySWQ6IGludGVybmV0R2F0ZXdheS5yZWYsXG4gICAgcm91dGVyVHlwZTogZWMyLlJvdXRlclR5cGUuR0FURVdBWSxcbiAgICBkZXN0aW5hdGlvbklwdjZDaWRyQmxvY2s6ICc6Oi8wJyxcbiAgfSk7XG5cbiAgLy8gRmluZCBhIENmblN1Ym5ldCAocmF3IGNsb3VkZm9ybWF0aW9uIHJlc291cmNlcykgY2hpbGQgdG8gdGhlIHB1YmxpY1xuICAvLyBzdWJuZXQgbm9kZXMuXG4gIGNvbnN0IGNmblN1Ym5ldCA9IHZhbHVlT3JEaWU8SUNvbnN0cnVjdCwgZWMyLkNmblN1Ym5ldD4oXG4gICAgc3VibmV0Lm5vZGUuY2hpbGRyZW4uZmluZChjID0+IGMgaW5zdGFuY2VvZiBlYzIuQ2ZuU3VibmV0KSxcbiAgICBuZXcgRXJyb3IoJ0NvdWxkbnQgZmluZCBhIENmblN1Ym5ldCcpLFxuICApO1xuXG4gIC8vIFVzZSB0aGUgaW50cmluc2ljIEZuOjpDaWRyIENsb3VkRm9ybWF0aW9uIGZ1bmN0aW9uIG9uIHRoZSBWUEMnc1xuICAvLyBmaXJzdCBJUHY2IGJsb2NrIHRvIGRldGVybWluZSBpcHY2IC82NCBjaWRycyBmb3IgZWFjaCBzdWJuZXQgYXNcbiAgLy8gYSBmdW5jdGlvbiBvZiB0aGUgcHVibGljIHN1Ym5ldCdzIGluZGV4LlxuICBjb25zdCB2cGNDaWRyQmxvY2sgPSBjZGsuRm4uc2VsZWN0KDAsIHZwYy52cGNJcHY2Q2lkckJsb2Nrcyk7XG4gIGNvbnN0IGlwdjZDaWRycyA9IGNkay5Gbi5jaWRyKFxuICAgIHZwY0NpZHJCbG9jayxcbiAgICB2cGMucHVibGljU3VibmV0cy5sZW5ndGgsXG4gICAgJzY0JyxcbiAgKTtcbiAgY2ZuU3VibmV0LmlwdjZDaWRyQmxvY2sgPSBjZGsuRm4uc2VsZWN0KGlkeCwgaXB2NkNpZHJzKTtcblxuICAvLyBUaGUgc3VibmV0IGRlcGVuZHMgb24gdGhlIGlwdjYgY2lkciBiZWluZyBhbGxvY2F0ZWQuXG4gIGNmblN1Ym5ldC5hZGREZXBlbmRlbmN5KGlwdjZCbG9jayk7XG5cbiAgZ3JvdXAxLm5vZGUuYWRkRGVwZW5kZW5jeShzdWJuZXQpO1xuICBncm91cDIubm9kZS5hZGREZXBlbmRlbmN5KHN1Ym5ldCk7XG59KTtcblxubGlzdGVuZXIuYWRkQWN0aW9uKCdhY3Rpb24xJywge1xuICBwcmlvcml0eTogMSxcbiAgY29uZGl0aW9uczogW1xuICAgIGVsYnYyLkxpc3RlbmVyQ29uZGl0aW9uLmhvc3RIZWFkZXJzKFsnZXhhbXBsZS5jb20nXSksXG4gIF0sXG4gIGFjdGlvbjogZWxidjIuTGlzdGVuZXJBY3Rpb24uZml4ZWRSZXNwb25zZSgyMDAsIHsgbWVzc2FnZUJvZHk6ICdzdWNjZXNzJyB9KSxcbn0pO1xuXG5ncm91cDEubWV0cmljVGFyZ2V0UmVzcG9uc2VUaW1lKCkuY3JlYXRlQWxhcm0oc3RhY2ssICdSZXNwb25zZVRpbWVIaWdoMScsIHtcbiAgdGhyZXNob2xkOiA1LFxuICBldmFsdWF0aW9uUGVyaW9kczogMixcbn0pO1xuXG5ncm91cDIubWV0cmljVGFyZ2V0UmVzcG9uc2VUaW1lKCkuY3JlYXRlQWxhcm0oc3RhY2ssICdSZXNwb25zZVRpbWVIaWdoMicsIHtcbiAgdGhyZXNob2xkOiA1LFxuICBldmFsdWF0aW9uUGVyaW9kczogMixcbn0pO1xuXG5hcHAuc3ludGgoKTtcbiJdfQ==