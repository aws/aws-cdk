import * as cdk from 'aws-cdk-lib/core';
import { Construct } from 'constructs';
import { CfnAutoScalingConfiguration } from 'aws-cdk-lib/aws-apprunner';

/**
 * Properties of the App Runner Auto Scaling Configuration.
 */
export interface AutoScalingConfigurationProps {
  /**
   * The name for the Auto Scaling Configuration.
   *
   * @default - a name generated by CloudFormation
   */
  readonly autoScalingConfigurationName?: string;

  /**
   * The maximum number of concurrent requests that an instance processes.
   * If the number of concurrent requests exceeds this limit, App Runner scales the service up.
   *
   * Must be between 1 and 200.
   *
   * @default 100
   */
  readonly maxConcurrency?: number;

  /**
   * The maximum number of instances that a service scales up to.
   * At most maxSize instances actively serve traffic for your service.
   *
   * Must be between 1 and 25.
   *
   * @default 25
   */
  readonly maxSize?: number;

  /**
   * The minimum number of instances that App Runner provisions for a service.
   * The service always has at least minSize provisioned instances.
   *
   *
   * Must be between 1 and 25.
   *
   * @default 1
   */
  readonly minSize?: number;
}

/**
 * Attributes for the App Runner Auto Scaling Configuration.
 */
export interface AutoScalingConfigurationAttributes {
  /**
   * The name of the Auto Scaling Configuration.
   */
  readonly autoScalingConfigurationName: string;

  /**
   * The revision of the Auto Scaling Configuration.
   */
  readonly autoScalingConfigurationRevision: number;
}

/**
 * Represents the App Runner Auto Scaling Configuration.
 */
export interface IAutoScalingConfiguration extends cdk.IResource {
  /**
   * The ARN of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationArn: string;

  /**
   * The Name of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationName: string;

  /**
   * The revision of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationRevision: number;
}

/**
 * The App Runner Auto Scaling Configuration.
 *
 * @resource AWS::AppRunner::AutoScalingConfiguration
 */
export class AutoScalingConfiguration extends cdk.Resource implements IAutoScalingConfiguration {
  /**
   * Imports an App Runner Auto Scaling Configuration from attributes
   */
  public static fromAutoScalingConfigurationAttributes(scope: Construct, id: string,
    attrs: AutoScalingConfigurationAttributes): IAutoScalingConfiguration {
    const autoScalingConfigurationName = attrs.autoScalingConfigurationName;
    const autoScalingConfigurationRevision = attrs.autoScalingConfigurationRevision;

    class Import extends cdk.Resource implements IAutoScalingConfiguration {
      public readonly autoScalingConfigurationName = autoScalingConfigurationName;
      public readonly autoScalingConfigurationRevision = autoScalingConfigurationRevision;
      public readonly autoScalingConfigurationArn = cdk.Stack.of(this).formatArn({
        resource: 'autoscalingconfiguration',
        service: 'apprunner',
        resourceName: `${attrs.autoScalingConfigurationName}/${attrs.autoScalingConfigurationRevision}`,
      });
    }

    return new Import(scope, id);
  }

  /**
   * Imports an App Runner Auto Scaling Configuration from its ARN
   */
  public static fromArn(scope: Construct, id: string, autoScalingConfigurationArn: string): IAutoScalingConfiguration {
    const resourceParts = cdk.Fn.split('/', autoScalingConfigurationArn);

    if (!resourceParts || resourceParts.length < 3) {
      throw new Error(`Unexpected ARN format: ${autoScalingConfigurationArn}`);
    }

    const autoScalingConfigurationName = cdk.Fn.select(0, resourceParts);
    const autoScalingConfigurationRevision = Number(cdk.Fn.select(1, resourceParts));

    class Import extends cdk.Resource implements IAutoScalingConfiguration {
      public readonly autoScalingConfigurationName = autoScalingConfigurationName;
      public readonly autoScalingConfigurationRevision = autoScalingConfigurationRevision;
      public readonly autoScalingConfigurationArn = autoScalingConfigurationArn;
    }

    return new Import(scope, id);
  }

  /**
   * The ARN of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationArn: string;

  /**
   * The name of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationName: string;

  /**
   * The revision of the Auto Scaling Configuration.
   * @attribute
   */
  readonly autoScalingConfigurationRevision: number;

  public constructor(scope: Construct, id: string, props: AutoScalingConfigurationProps = {}) {
    super(scope, id, {
      physicalName: props.autoScalingConfigurationName,
    });

    this.validateAutoScalingConfiguration(props);

    const resource = new CfnAutoScalingConfiguration(this, 'Resource', {
      autoScalingConfigurationName: props.autoScalingConfigurationName,
      maxConcurrency: props.maxConcurrency,
      maxSize: props.maxSize,
      minSize: props.minSize,
    });

    this.autoScalingConfigurationArn = resource.attrAutoScalingConfigurationArn;
    this.autoScalingConfigurationRevision = resource.attrAutoScalingConfigurationRevision;
    this.autoScalingConfigurationName = resource.ref;
  }

  private validateAutoScalingConfiguration(props: AutoScalingConfigurationProps) {
    if (
      props.autoScalingConfigurationName !== undefined &&
      !cdk.Token.isUnresolved(props.autoScalingConfigurationName) &&
      !/^[A-Za-z0-9][A-Za-z0-9\-_]{3,31}$/.test(props.autoScalingConfigurationName)
    ) {
      throw new Error(`autoScalingConfigurationName must match the ^[A-Za-z0-9][A-Za-z0-9\-_]{3,31}$ pattern, got ${props.autoScalingConfigurationName}`);
    }

    const isMinSizeDefined = typeof props.minSize === 'number';
    const isMaxSizeDefined = typeof props.maxSize === 'number';
    const isMaxConcurrencyDefined = typeof props.maxConcurrency === 'number';

    if (isMinSizeDefined && (props.minSize < 1 || props.minSize > 25)) {
      throw new Error(`minSize must be between 1 and 25, got ${props.minSize}`);
    }

    if (isMaxSizeDefined && (props.maxSize < 1 || props.maxSize > 25)) {
      throw new Error(`maxSize must be between 1 and 25, got ${props.maxSize}`);
    }

    if (isMinSizeDefined && isMaxSizeDefined && !(props.minSize < props.maxSize)) {
      throw new Error('maxSize must be greater than minSize');
    }

    if (isMaxConcurrencyDefined && (props.maxConcurrency < 1 || props.maxConcurrency > 200)) {
      throw new Error(`maxConcurrency must be between 1 and 200, got ${props.maxConcurrency}`);
    }
  }

}
