"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("@aws-cdk/assertions");
const iam = require("@aws-cdk/aws-iam");
const lambda = require("@aws-cdk/aws-lambda");
const cdk = require("@aws-cdk/core");
const cloudfront = require("../../lib");
let app;
let stack;
beforeEach(() => {
    app = new cdk.App();
    stack = new cdk.Stack(app, 'Stack', {
        env: { account: '111111111111', region: 'testregion' },
    });
});
describe('stacks', () => {
    test('creates a custom resource and supporting resources in main stack', () => {
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [{
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: { Service: 'lambda.amazonaws.com' },
                    }],
                Version: '2012-10-17',
            },
            ManagedPolicyArns: [
                { 'Fn::Sub': 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole' },
            ],
            Policies: [{
                    PolicyName: 'Inline',
                    PolicyDocument: {
                        Version: '2012-10-17',
                        Statement: [{
                                Effect: 'Allow',
                                Resource: {
                                    'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':ssm:us-east-1:111111111111:parameter/cdk/EdgeFunctionArn/*']],
                                },
                                Action: ['ssm:GetParameter'],
                            }],
                    },
                }],
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Function', {
            Handler: '__entrypoint__.handler',
            Role: {
                'Fn::GetAtt': ['CustomCrossRegionStringParameterReaderCustomResourceProviderRole71CD6825', 'Arn'],
            },
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::CrossRegionStringParameterReader', {
            ServiceToken: {
                'Fn::GetAtt': ['CustomCrossRegionStringParameterReaderCustomResourceProviderHandler65B5F33A', 'Arn'],
            },
            Region: 'us-east-1',
            ParameterName: '/cdk/EdgeFunctionArn/testregion/Stack/MyFn',
        });
    });
    test('creates the actual function and supporting resources in us-east-1 stack', () => {
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        const fnStack = getFnStack();
        assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: { Service: 'lambda.amazonaws.com' },
                    },
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: { Service: 'edgelambda.amazonaws.com' },
                    },
                ],
                Version: '2012-10-17',
            },
            ManagedPolicyArns: [
                { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':iam::aws:policy/service-role/AWSLambdaBasicExecutionRole']] },
            ],
        });
        assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::Lambda::Function', {
            Code: { ZipFile: 'foo' },
            Handler: 'index.handler',
            Role: { 'Fn::GetAtt': ['MyFnServiceRoleF3016589', 'Arn'] },
            Runtime: 'nodejs14.x',
        });
        assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::Lambda::Version', {
            FunctionName: { Ref: 'MyFn6F8F742F' },
        });
        assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::SSM::Parameter', {
            Type: 'String',
            Value: { Ref: 'MyFnCurrentVersion309B29FC565d8e08ba88650b100357cd5eaf4bbb' },
            Name: '/cdk/EdgeFunctionArn/testregion/Stack/MyFn',
        });
    });
    test('us-east-1 stack inherits account of parent stack', () => {
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        const fnStack = getFnStack();
        expect(fnStack.account).toEqual('111111111111');
    });
    test('us-east-1 stack inherits account of parent stack, when parent stack account is undefined', () => {
        stack = new cdk.Stack(app, 'StackWithDefaultAccount', {
            env: { region: 'testregion' },
        });
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        const fnStack = getFnStack();
        expect(fnStack.account).toEqual(cdk.Aws.ACCOUNT_ID);
    });
    test('creates minimal constructs if scope region is us-east-1', () => {
        app = new cdk.App();
        stack = new cdk.Stack(app, 'Stack', {
            env: { account: '111111111111', region: 'us-east-1' },
        });
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: { Service: 'lambda.amazonaws.com' },
                    },
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: { Service: 'edgelambda.amazonaws.com' },
                    },
                ],
                Version: '2012-10-17',
            },
            ManagedPolicyArns: [
                { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':iam::aws:policy/service-role/AWSLambdaBasicExecutionRole']] },
            ],
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Function', {
            Code: { ZipFile: 'foo' },
            Handler: 'index.handler',
            Role: { 'Fn::GetAtt': ['MyFnServiceRole3F9D41E1', 'Arn'] },
            Runtime: 'nodejs14.x',
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Version', {
            FunctionName: { Ref: 'MyFn223608AD' },
        });
    });
    test('only one cross-region stack is created for multiple functions', () => {
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn1', defaultEdgeFunctionProps());
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn2', defaultEdgeFunctionProps());
        const fnStack = getFnStack();
        assertions_1.Template.fromStack(fnStack).resourceCountIs('AWS::Lambda::Function', 2);
    });
    test('can set the stack id for each function', () => {
        const fn1StackId = 'edge-lambda-stack-testregion-1';
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn1', defaultEdgeFunctionProps(fn1StackId));
        const fn2StackId = 'edge-lambda-stack-testregion-2';
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn2', defaultEdgeFunctionProps(fn2StackId));
        const fn1Stack = app.node.findChild(fn1StackId);
        assertions_1.Template.fromStack(fn1Stack).resourceCountIs('AWS::Lambda::Function', 1);
        const fn2Stack = app.node.findChild(fn2StackId);
        assertions_1.Template.fromStack(fn2Stack).resourceCountIs('AWS::Lambda::Function', 1);
    });
    test('cross-region stack supports defining functions within stages', () => {
        app = new cdk.App();
        const stage = new cdk.Stage(app, 'Stage');
        stack = new cdk.Stack(stage, 'Stack', {
            env: { account: '111111111111', region: 'testregion' },
        });
        new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Function', {
            Handler: '__entrypoint__.handler',
            Role: {
                'Fn::GetAtt': ['CustomCrossRegionStringParameterReaderCustomResourceProviderRole71CD6825', 'Arn'],
            },
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::CrossRegionStringParameterReader', {
            ServiceToken: {
                'Fn::GetAtt': ['CustomCrossRegionStringParameterReaderCustomResourceProviderHandler65B5F33A', 'Arn'],
            },
            Region: 'us-east-1',
            ParameterName: '/cdk/EdgeFunctionArn/testregion/Stage/Stack/MyFn',
        });
    });
    test('a single EdgeFunction used in multiple stacks creates mutiple stacks in us-east-1', () => {
        const firstStack = new cdk.Stack(app, 'FirstStack', {
            env: { account: '111111111111', region: 'testregion' },
        });
        const secondStack = new cdk.Stack(app, 'SecondStack', {
            env: { account: '111111111111', region: 'testregion' },
        });
        new cloudfront.experimental.EdgeFunction(firstStack, 'MyFn', defaultEdgeFunctionProps());
        new cloudfront.experimental.EdgeFunction(secondStack, 'MyFn', defaultEdgeFunctionProps());
        // Two stacks in us-east-1
        const firstFnStack = app.node.findChild(`edge-lambda-stack-${firstStack.node.addr}`);
        const secondFnStack = app.node.findChild(`edge-lambda-stack-${secondStack.node.addr}`);
        // Two SSM parameters
        assertions_1.Template.fromStack(firstFnStack).hasResourceProperties('AWS::SSM::Parameter', {
            Name: '/cdk/EdgeFunctionArn/testregion/FirstStack/MyFn',
        });
        assertions_1.Template.fromStack(secondFnStack).hasResourceProperties('AWS::SSM::Parameter', {
            Name: '/cdk/EdgeFunctionArn/testregion/SecondStack/MyFn',
        });
    });
});
test('addAlias() creates alias in function stack', () => {
    const fn = new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
    fn.addAlias('MyCurrentAlias');
    const fnStack = getFnStack();
    assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::Lambda::Alias', {
        Name: 'MyCurrentAlias',
    });
});
test('mutliple aliases with the same name can be added to the same stack', () => {
    const fn1 = new cloudfront.experimental.EdgeFunction(stack, 'MyFn1', defaultEdgeFunctionProps());
    const fn2 = new cloudfront.experimental.EdgeFunction(stack, 'MyFn2', defaultEdgeFunctionProps());
    fn1.addAlias('live');
    fn2.addAlias('live');
    const fnStack = getFnStack();
    assertions_1.Template.fromStack(fnStack).resourceCountIs('AWS::Lambda::Function', 2);
    assertions_1.Template.fromStack(fnStack).resourceCountIs('AWS::Lambda::Alias', 2);
});
test('addPermission() creates permissions in function stack', () => {
    const fn = new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
    fn.addPermission('MyPerms', {
        action: 'lambda:InvokeFunction',
        principal: new iam.AccountPrincipal('123456789012'),
    });
    const fnStack = getFnStack();
    assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::Lambda::Permission', {
        Action: 'lambda:InvokeFunction',
        Principal: '123456789012',
    });
});
test('metric methods', () => {
    const fn = new cloudfront.experimental.EdgeFunction(stack, 'MyFn', defaultEdgeFunctionProps());
    const metrics = new Array();
    metrics.push(fn.metricDuration());
    metrics.push(fn.metricErrors());
    metrics.push(fn.metricInvocations());
    metrics.push(fn.metricThrottles());
    for (const metric of metrics) {
        expect(metric.namespace).toEqual('AWS/Lambda');
        expect(metric.region).toEqual('us-east-1');
    }
});
test('cross-region stack supports new-style synthesis with assets', () => {
    app = new cdk.App({
        context: { '@aws-cdk/core:newStyleStackSynthesis': true },
    });
    stack = new cdk.Stack(app, 'Stack', {
        env: { account: '111111111111', region: 'testregion' },
    });
    new cloudfront.experimental.EdgeFunction(stack, 'MyFn', {
        code: lambda.Code.fromAsset(path.join(__dirname, 'my-lambda-handler')),
        handler: 'index.handler',
        runtime: lambda.Runtime.PYTHON_3_8,
    });
    expect(() => app.synth()).not.toThrow();
});
test('SSM parameter name is sanitized to remove disallowed characters', () => {
    new cloudfront.experimental.EdgeFunction(stack, 'My Bad#Fn$Name-With.Bonus', defaultEdgeFunctionProps());
    const fnStack = getFnStack();
    assertions_1.Template.fromStack(fnStack).hasResourceProperties('AWS::SSM::Parameter', {
        Name: '/cdk/EdgeFunctionArn/testregion/Stack/My_Bad_Fn_Name-With.Bonus',
    });
});
function defaultEdgeFunctionProps(stackId) {
    return {
        code: lambda.Code.fromInline('foo'),
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        stackId: stackId,
    };
}
function getFnStack() {
    return app.node.findChild(`edge-lambda-stack-${stack.node.addr}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRnZS1mdW5jdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZWRnZS1mdW5jdGlvbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLG9EQUErQztBQUUvQyx3Q0FBd0M7QUFDeEMsOENBQThDO0FBQzlDLHFDQUFxQztBQUNyQyx3Q0FBd0M7QUFFeEMsSUFBSSxHQUFZLENBQUM7QUFDakIsSUFBSSxLQUFnQixDQUFDO0FBRXJCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDcEIsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFO1FBQ2xDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRTtLQUN2RCxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO0lBQ3RCLElBQUksQ0FBQyxrRUFBa0UsRUFBRSxHQUFHLEVBQUU7UUFDNUUsSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLHdCQUF3QixFQUFFLENBQUMsQ0FBQztRQUVwRixxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsRUFBRTtZQUNoRSx3QkFBd0IsRUFBRTtnQkFDeEIsU0FBUyxFQUFFLENBQUM7d0JBQ1YsTUFBTSxFQUFFLGdCQUFnQjt3QkFDeEIsTUFBTSxFQUFFLE9BQU87d0JBQ2YsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFO3FCQUMvQyxDQUFDO2dCQUNGLE9BQU8sRUFBRSxZQUFZO2FBQ3RCO1lBQ0QsaUJBQWlCLEVBQUU7Z0JBQ2pCLEVBQUUsU0FBUyxFQUFFLGdG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QUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxxQkFBcUIsRUFBRTtRQUN2RSxJQUFJLEVBQUUsaUVBQWlFO0tBQ3hFLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyx3QkFBd0IsQ0FBQyxPQUFnQjtJQUNoRCxPQUFPO1FBQ0wsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUNuQyxPQUFPLEVBQUUsZUFBZTtRQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1FBQ25DLE9BQU8sRUFBRSxPQUFPO0tBQ2pCLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxVQUFVO0lBQ2pCLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQWMsQ0FBQztBQUNqRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnQGF3cy1jZGsvYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBjbG91ZHdhdGNoIGZyb20gJ0Bhd3MtY2RrL2F3cy1jbG91ZHdhdGNoJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSAnLi4vLi4vbGliJztcblxubGV0IGFwcDogY2RrLkFwcDtcbmxldCBzdGFjazogY2RrLlN0YWNrO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgYXBwID0gbmV3IGNkay5BcHAoKTtcbiAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgIGVudjogeyBhY2NvdW50OiAnMTExMTExMTExMTExJywgcmVnaW9uOiAndGVzdHJlZ2lvbicgfSxcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ3N0YWNrcycsICgpID0+IHtcbiAgdGVzdCgnY3JlYXRlcyBhIGN1c3RvbSByZXNvdXJjZSBhbmQgc3VwcG9ydGluZyByZXNvdXJjZXMgaW4gbWFpbiBzdGFjaycsICgpID0+IHtcbiAgICBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcygpKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6Um9sZScsIHtcbiAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFt7XG4gICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBQcmluY2lwYWw6IHsgU2VydmljZTogJ2xhbWJkYS5hbWF6b25hd3MuY29tJyB9LFxuICAgICAgICB9XSxcbiAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgfSxcbiAgICAgIE1hbmFnZWRQb2xpY3lBcm5zOiBbXG4gICAgICAgIHsgJ0ZuOjpTdWInOiAnYXJuOiR7QVdTOjpQYXJ0aXRpb259OmlhbTo6YXdzOnBvbGljeS9zZXJ2aWNlLXJvbGUvQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlJyB9LFxuICAgICAgXSxcbiAgICAgIFBvbGljaWVzOiBbe1xuICAgICAgICBQb2xpY3lOYW1lOiAnSW5saW5lJyxcbiAgICAgICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICAgICAgU3RhdGVtZW50OiBbe1xuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgICAgJ0ZuOjpKb2luJzogWycnLCBbJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCAnOnNzbTp1cy1lYXN0LTE6MTExMTExMTExMTExOnBhcmFtZXRlci9jZGsvRWRnZUZ1bmN0aW9uQXJuLyonXV0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQWN0aW9uOiBbJ3NzbTpHZXRQYXJhbWV0ZXInXSxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSxcbiAgICAgIH1dLFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgICBIYW5kbGVyOiAnX19lbnRyeXBvaW50X18uaGFuZGxlcicsXG4gICAgICBSb2xlOiB7XG4gICAgICAgICdGbjo6R2V0QXR0JzogWydDdXN0b21Dcm9zc1JlZ2lvblN0cmluZ1BhcmFtZXRlclJlYWRlckN1c3RvbVJlc291cmNlUHJvdmlkZXJSb2xlNzFDRDY4MjUnLCAnQXJuJ10sXG4gICAgICB9LFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdDdXN0b206OkNyb3NzUmVnaW9uU3RyaW5nUGFyYW1ldGVyUmVhZGVyJywge1xuICAgICAgU2VydmljZVRva2VuOiB7XG4gICAgICAgICdGbjo6R2V0QXR0JzogWydDdXN0b21Dcm9zc1JlZ2lvblN0cmluZ1BhcmFtZXRlclJlYWRlckN1c3RvbVJlc291cmNlUHJvdmlkZXJIYW5kbGVyNjVCNUYzM0EnLCAnQXJuJ10sXG4gICAgICB9LFxuICAgICAgUmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIFBhcmFtZXRlck5hbWU6ICcvY2RrL0VkZ2VGdW5jdGlvbkFybi90ZXN0cmVnaW9uL1N0YWNrL015Rm4nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdjcmVhdGVzIHRoZSBhY3R1YWwgZnVuY3Rpb24gYW5kIHN1cHBvcnRpbmcgcmVzb3VyY2VzIGluIHVzLWVhc3QtMSBzdGFjaycsICgpID0+IHtcbiAgICBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcygpKTtcblxuICAgIGNvbnN0IGZuU3RhY2sgPSBnZXRGblN0YWNrKCk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6Um9sZScsIHtcbiAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBBY3Rpb246ICdzdHM6QXNzdW1lUm9sZScsXG4gICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICBQcmluY2lwYWw6IHsgU2VydmljZTogJ2xhbWJkYS5hbWF6b25hd3MuY29tJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUHJpbmNpcGFsOiB7IFNlcnZpY2U6ICdlZGdlbGFtYmRhLmFtYXpvbmF3cy5jb20nIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgfSxcbiAgICAgIE1hbmFnZWRQb2xpY3lBcm5zOiBbXG4gICAgICAgIHsgJ0ZuOjpKb2luJzogWycnLCBbJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCAnOmlhbTo6YXdzOnBvbGljeS9zZXJ2aWNlLXJvbGUvQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlJ11dIH0sXG4gICAgICBdLFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhmblN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHtcbiAgICAgIENvZGU6IHsgWmlwRmlsZTogJ2ZvbycgfSxcbiAgICAgIEhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIFJvbGU6IHsgJ0ZuOjpHZXRBdHQnOiBbJ015Rm5TZXJ2aWNlUm9sZUYzMDE2NTg5JywgJ0FybiddIH0sXG4gICAgICBSdW50aW1lOiAnbm9kZWpzMTQueCcsXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKGZuU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OlZlcnNpb24nLCB7XG4gICAgICBGdW5jdGlvbk5hbWU6IHsgUmVmOiAnTXlGbjZGOEY3NDJGJyB9LFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhmblN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6U1NNOjpQYXJhbWV0ZXInLCB7XG4gICAgICBUeXBlOiAnU3RyaW5nJyxcbiAgICAgIFZhbHVlOiB7IFJlZjogJ015Rm5DdXJyZW50VmVyc2lvbjMwOUIyOUZDNTY1ZDhlMDhiYTg4NjUwYjEwMDM1N2NkNWVhZjRiYmInIH0sXG4gICAgICBOYW1lOiAnL2Nkay9FZGdlRnVuY3Rpb25Bcm4vdGVzdHJlZ2lvbi9TdGFjay9NeUZuJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgndXMtZWFzdC0xIHN0YWNrIGluaGVyaXRzIGFjY291bnQgb2YgcGFyZW50IHN0YWNrJywgKCkgPT4ge1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuJywgZGVmYXVsdEVkZ2VGdW5jdGlvblByb3BzKCkpO1xuXG4gICAgY29uc3QgZm5TdGFjayA9IGdldEZuU3RhY2soKTtcblxuICAgIGV4cGVjdChmblN0YWNrLmFjY291bnQpLnRvRXF1YWwoJzExMTExMTExMTExMScpO1xuICB9KTtcblxuICB0ZXN0KCd1cy1lYXN0LTEgc3RhY2sgaW5oZXJpdHMgYWNjb3VudCBvZiBwYXJlbnQgc3RhY2ssIHdoZW4gcGFyZW50IHN0YWNrIGFjY291bnQgaXMgdW5kZWZpbmVkJywgKCkgPT4ge1xuICAgIHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsICdTdGFja1dpdGhEZWZhdWx0QWNjb3VudCcsIHtcbiAgICAgIGVudjogeyByZWdpb246ICd0ZXN0cmVnaW9uJyB9LFxuICAgIH0pO1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuJywgZGVmYXVsdEVkZ2VGdW5jdGlvblByb3BzKCkpO1xuXG4gICAgY29uc3QgZm5TdGFjayA9IGdldEZuU3RhY2soKTtcblxuICAgIGV4cGVjdChmblN0YWNrLmFjY291bnQpLnRvRXF1YWwoY2RrLkF3cy5BQ0NPVU5UX0lEKTtcbiAgfSk7XG5cbiAgdGVzdCgnY3JlYXRlcyBtaW5pbWFsIGNvbnN0cnVjdHMgaWYgc2NvcGUgcmVnaW9uIGlzIHVzLWVhc3QtMScsICgpID0+IHtcbiAgICBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICAgIHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsICdTdGFjaycsIHtcbiAgICAgIGVudjogeyBhY2NvdW50OiAnMTExMTExMTExMTExJywgcmVnaW9uOiAndXMtZWFzdC0xJyB9LFxuICAgIH0pO1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuJywgZGVmYXVsdEVkZ2VGdW5jdGlvblByb3BzKCkpO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpSb2xlJywge1xuICAgICAgQXNzdW1lUm9sZVBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ3N0czpBc3N1bWVSb2xlJyxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFByaW5jaXBhbDogeyBTZXJ2aWNlOiAnbGFtYmRhLmFtYXpvbmF3cy5jb20nIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBBY3Rpb246ICdzdHM6QXNzdW1lUm9sZScsXG4gICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICBQcmluY2lwYWw6IHsgU2VydmljZTogJ2VkZ2VsYW1iZGEuYW1hem9uYXdzLmNvbScgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICB9LFxuICAgICAgTWFuYWdlZFBvbGljeUFybnM6IFtcbiAgICAgICAgeyAnRm46OkpvaW4nOiBbJycsIFsnYXJuOicsIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sICc6aWFtOjphd3M6cG9saWN5L3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGUnXV0gfSxcbiAgICAgIF0sXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHtcbiAgICAgIENvZGU6IHsgWmlwRmlsZTogJ2ZvbycgfSxcbiAgICAgIEhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIFJvbGU6IHsgJ0ZuOjpHZXRBdHQnOiBbJ015Rm5TZXJ2aWNlUm9sZTNGOUQ0MUUxJywgJ0FybiddIH0sXG4gICAgICBSdW50aW1lOiAnbm9kZWpzMTQueCcsXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpWZXJzaW9uJywge1xuICAgICAgRnVuY3Rpb25OYW1lOiB7IFJlZjogJ015Rm4yMjM2MDhBRCcgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnb25seSBvbmUgY3Jvc3MtcmVnaW9uIHN0YWNrIGlzIGNyZWF0ZWQgZm9yIG11bHRpcGxlIGZ1bmN0aW9ucycsICgpID0+IHtcbiAgICBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbjEnLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG4gICAgbmV3IGNsb3VkZnJvbnQuZXhwZXJpbWVudGFsLkVkZ2VGdW5jdGlvbihzdGFjaywgJ015Rm4yJywgZGVmYXVsdEVkZ2VGdW5jdGlvblByb3BzKCkpO1xuXG4gICAgY29uc3QgZm5TdGFjayA9IGdldEZuU3RhY2soKTtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykucmVzb3VyY2VDb3VudElzKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCAyKTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIHNldCB0aGUgc3RhY2sgaWQgZm9yIGVhY2ggZnVuY3Rpb24nLCAoKSA9PiB7XG4gICAgY29uc3QgZm4xU3RhY2tJZCA9ICdlZGdlLWxhbWJkYS1zdGFjay10ZXN0cmVnaW9uLTEnO1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuMScsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcyhmbjFTdGFja0lkKSk7XG4gICAgY29uc3QgZm4yU3RhY2tJZCA9ICdlZGdlLWxhbWJkYS1zdGFjay10ZXN0cmVnaW9uLTInO1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuMicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcyhmbjJTdGFja0lkKSk7XG5cbiAgICBjb25zdCBmbjFTdGFjayA9IGFwcC5ub2RlLmZpbmRDaGlsZChmbjFTdGFja0lkKSBhcyBjZGsuU3RhY2s7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKGZuMVN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIDEpO1xuICAgIGNvbnN0IGZuMlN0YWNrID0gYXBwLm5vZGUuZmluZENoaWxkKGZuMlN0YWNrSWQpIGFzIGNkay5TdGFjaztcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soZm4yU3RhY2spLnJlc291cmNlQ291bnRJcygnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywgMSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2Nyb3NzLXJlZ2lvbiBzdGFjayBzdXBwb3J0cyBkZWZpbmluZyBmdW5jdGlvbnMgd2l0aGluIHN0YWdlcycsICgpID0+IHtcbiAgICBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICAgIGNvbnN0IHN0YWdlID0gbmV3IGNkay5TdGFnZShhcHAsICdTdGFnZScpO1xuICAgIHN0YWNrID0gbmV3IGNkay5TdGFjayhzdGFnZSwgJ1N0YWNrJywge1xuICAgICAgZW52OiB7IGFjY291bnQ6ICcxMTExMTExMTExMTEnLCByZWdpb246ICd0ZXN0cmVnaW9uJyB9LFxuICAgIH0pO1xuXG4gICAgbmV3IGNsb3VkZnJvbnQuZXhwZXJpbWVudGFsLkVkZ2VGdW5jdGlvbihzdGFjaywgJ015Rm4nLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge1xuICAgICAgSGFuZGxlcjogJ19fZW50cnlwb2ludF9fLmhhbmRsZXInLFxuICAgICAgUm9sZToge1xuICAgICAgICAnRm46OkdldEF0dCc6IFsnQ3VzdG9tQ3Jvc3NSZWdpb25TdHJpbmdQYXJhbWV0ZXJSZWFkZXJDdXN0b21SZXNvdXJjZVByb3ZpZGVyUm9sZTcxQ0Q2ODI1JywgJ0FybiddLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpDcm9zc1JlZ2lvblN0cmluZ1BhcmFtZXRlclJlYWRlcicsIHtcbiAgICAgIFNlcnZpY2VUb2tlbjoge1xuICAgICAgICAnRm46OkdldEF0dCc6IFsnQ3VzdG9tQ3Jvc3NSZWdpb25TdHJpbmdQYXJhbWV0ZXJSZWFkZXJDdXN0b21SZXNvdXJjZVByb3ZpZGVySGFuZGxlcjY1QjVGMzNBJywgJ0FybiddLFxuICAgICAgfSxcbiAgICAgIFJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBQYXJhbWV0ZXJOYW1lOiAnL2Nkay9FZGdlRnVuY3Rpb25Bcm4vdGVzdHJlZ2lvbi9TdGFnZS9TdGFjay9NeUZuJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYSBzaW5nbGUgRWRnZUZ1bmN0aW9uIHVzZWQgaW4gbXVsdGlwbGUgc3RhY2tzIGNyZWF0ZXMgbXV0aXBsZSBzdGFja3MgaW4gdXMtZWFzdC0xJywgKCkgPT4ge1xuICAgIGNvbnN0IGZpcnN0U3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ0ZpcnN0U3RhY2snLCB7XG4gICAgICBlbnY6IHsgYWNjb3VudDogJzExMTExMTExMTExMScsIHJlZ2lvbjogJ3Rlc3RyZWdpb24nIH0sXG4gICAgfSk7XG4gICAgY29uc3Qgc2Vjb25kU3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ1NlY29uZFN0YWNrJywge1xuICAgICAgZW52OiB7IGFjY291bnQ6ICcxMTExMTExMTExMTEnLCByZWdpb246ICd0ZXN0cmVnaW9uJyB9LFxuICAgIH0pO1xuICAgIG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oZmlyc3RTdGFjaywgJ015Rm4nLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG4gICAgbmV3IGNsb3VkZnJvbnQuZXhwZXJpbWVudGFsLkVkZ2VGdW5jdGlvbihzZWNvbmRTdGFjaywgJ015Rm4nLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG5cbiAgICAvLyBUd28gc3RhY2tzIGluIHVzLWVhc3QtMVxuICAgIGNvbnN0IGZpcnN0Rm5TdGFjayA9IGFwcC5ub2RlLmZpbmRDaGlsZChgZWRnZS1sYW1iZGEtc3RhY2stJHtmaXJzdFN0YWNrLm5vZGUuYWRkcn1gKSBhcyBjZGsuU3RhY2s7XG4gICAgY29uc3Qgc2Vjb25kRm5TdGFjayA9IGFwcC5ub2RlLmZpbmRDaGlsZChgZWRnZS1sYW1iZGEtc3RhY2stJHtzZWNvbmRTdGFjay5ub2RlLmFkZHJ9YCkgYXMgY2RrLlN0YWNrO1xuXG4gICAgLy8gVHdvIFNTTSBwYXJhbWV0ZXJzXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKGZpcnN0Rm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNTTTo6UGFyYW1ldGVyJywge1xuICAgICAgTmFtZTogJy9jZGsvRWRnZUZ1bmN0aW9uQXJuL3Rlc3RyZWdpb24vRmlyc3RTdGFjay9NeUZuJyxcbiAgICB9KTtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc2Vjb25kRm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNTTTo6UGFyYW1ldGVyJywge1xuICAgICAgTmFtZTogJy9jZGsvRWRnZUZ1bmN0aW9uQXJuL3Rlc3RyZWdpb24vU2Vjb25kU3RhY2svTXlGbicsXG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbnRlc3QoJ2FkZEFsaWFzKCkgY3JlYXRlcyBhbGlhcyBpbiBmdW5jdGlvbiBzdGFjaycsICgpID0+IHtcbiAgY29uc3QgZm4gPSBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcygpKTtcblxuICBmbi5hZGRBbGlhcygnTXlDdXJyZW50QWxpYXMnKTtcblxuICBjb25zdCBmblN0YWNrID0gZ2V0Rm5TdGFjaygpO1xuICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkxhbWJkYTo6QWxpYXMnLCB7XG4gICAgTmFtZTogJ015Q3VycmVudEFsaWFzJyxcbiAgfSk7XG59KTtcblxudGVzdCgnbXV0bGlwbGUgYWxpYXNlcyB3aXRoIHRoZSBzYW1lIG5hbWUgY2FuIGJlIGFkZGVkIHRvIHRoZSBzYW1lIHN0YWNrJywgKCkgPT4ge1xuICBjb25zdCBmbjEgPSBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbjEnLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG4gIGNvbnN0IGZuMiA9IG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuMicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcygpKTtcbiAgZm4xLmFkZEFsaWFzKCdsaXZlJyk7XG4gIGZuMi5hZGRBbGlhcygnbGl2ZScpO1xuXG4gIGNvbnN0IGZuU3RhY2sgPSBnZXRGblN0YWNrKCk7XG4gIFRlbXBsYXRlLmZyb21TdGFjayhmblN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIDIpO1xuICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykucmVzb3VyY2VDb3VudElzKCdBV1M6OkxhbWJkYTo6QWxpYXMnLCAyKTtcbn0pO1xuXG50ZXN0KCdhZGRQZXJtaXNzaW9uKCkgY3JlYXRlcyBwZXJtaXNzaW9ucyBpbiBmdW5jdGlvbiBzdGFjaycsICgpID0+IHtcbiAgY29uc3QgZm4gPSBuZXcgY2xvdWRmcm9udC5leHBlcmltZW50YWwuRWRnZUZ1bmN0aW9uKHN0YWNrLCAnTXlGbicsIGRlZmF1bHRFZGdlRnVuY3Rpb25Qcm9wcygpKTtcblxuICBmbi5hZGRQZXJtaXNzaW9uKCdNeVBlcm1zJywge1xuICAgIGFjdGlvbjogJ2xhbWJkYTpJbnZva2VGdW5jdGlvbicsXG4gICAgcHJpbmNpcGFsOiBuZXcgaWFtLkFjY291bnRQcmluY2lwYWwoJzEyMzQ1Njc4OTAxMicpLFxuICB9KTtcblxuICBjb25zdCBmblN0YWNrID0gZ2V0Rm5TdGFjaygpO1xuICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkxhbWJkYTo6UGVybWlzc2lvbicsIHtcbiAgICBBY3Rpb246ICdsYW1iZGE6SW52b2tlRnVuY3Rpb24nLFxuICAgIFByaW5jaXBhbDogJzEyMzQ1Njc4OTAxMicsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ21ldHJpYyBtZXRob2RzJywgKCkgPT4ge1xuICBjb25zdCBmbiA9IG5ldyBjbG91ZGZyb250LmV4cGVyaW1lbnRhbC5FZGdlRnVuY3Rpb24oc3RhY2ssICdNeUZuJywgZGVmYXVsdEVkZ2VGdW5jdGlvblByb3BzKCkpO1xuXG4gIGNvbnN0IG1ldHJpY3MgPSBuZXcgQXJyYXk8Y2xvdWR3YXRjaC5NZXRyaWM+KCk7XG4gIG1ldHJpY3MucHVzaChmbi5tZXRyaWNEdXJhdGlvbigpKTtcbiAgbWV0cmljcy5wdXNoKGZuLm1ldHJpY0Vycm9ycygpKTtcbiAgbWV0cmljcy5wdXNoKGZuLm1ldHJpY0ludm9jYXRpb25zKCkpO1xuICBtZXRyaWNzLnB1c2goZm4ubWV0cmljVGhyb3R0bGVzKCkpO1xuXG4gIGZvciAoY29uc3QgbWV0cmljIG9mIG1ldHJpY3MpIHtcbiAgICBleHBlY3QobWV0cmljLm5hbWVzcGFjZSkudG9FcXVhbCgnQVdTL0xhbWJkYScpO1xuICAgIGV4cGVjdChtZXRyaWMucmVnaW9uKS50b0VxdWFsKCd1cy1lYXN0LTEnKTtcbiAgfVxufSk7XG5cbnRlc3QoJ2Nyb3NzLXJlZ2lvbiBzdGFjayBzdXBwb3J0cyBuZXctc3R5bGUgc3ludGhlc2lzIHdpdGggYXNzZXRzJywgKCkgPT4ge1xuICBhcHAgPSBuZXcgY2RrLkFwcCh7XG4gICAgY29udGV4dDogeyAnQGF3cy1jZGsvY29yZTpuZXdTdHlsZVN0YWNrU3ludGhlc2lzJzogdHJ1ZSB9LFxuICB9KTtcbiAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgIGVudjogeyBhY2NvdW50OiAnMTExMTExMTExMTExJywgcmVnaW9uOiAndGVzdHJlZ2lvbicgfSxcbiAgfSk7XG5cbiAgbmV3IGNsb3VkZnJvbnQuZXhwZXJpbWVudGFsLkVkZ2VGdW5jdGlvbihzdGFjaywgJ015Rm4nLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdteS1sYW1iZGEtaGFuZGxlcicpKSxcbiAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfOCxcbiAgfSk7XG5cbiAgZXhwZWN0KCgpID0+IGFwcC5zeW50aCgpKS5ub3QudG9UaHJvdygpO1xufSk7XG5cbnRlc3QoJ1NTTSBwYXJhbWV0ZXIgbmFtZSBpcyBzYW5pdGl6ZWQgdG8gcmVtb3ZlIGRpc2FsbG93ZWQgY2hhcmFjdGVycycsICgpID0+IHtcbiAgbmV3IGNsb3VkZnJvbnQuZXhwZXJpbWVudGFsLkVkZ2VGdW5jdGlvbihzdGFjaywgJ015IEJhZCNGbiROYW1lLVdpdGguQm9udXMnLCBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoKSk7XG5cbiAgY29uc3QgZm5TdGFjayA9IGdldEZuU3RhY2soKTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soZm5TdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNTTTo6UGFyYW1ldGVyJywge1xuICAgIE5hbWU6ICcvY2RrL0VkZ2VGdW5jdGlvbkFybi90ZXN0cmVnaW9uL1N0YWNrL015X0JhZF9Gbl9OYW1lLVdpdGguQm9udXMnLFxuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiBkZWZhdWx0RWRnZUZ1bmN0aW9uUHJvcHMoc3RhY2tJZD86IHN0cmluZykge1xuICByZXR1cm4ge1xuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2ZvbycpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICBzdGFja0lkOiBzdGFja0lkLFxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRGblN0YWNrKCk6IGNkay5TdGFjayB7XG4gIHJldHVybiBhcHAubm9kZS5maW5kQ2hpbGQoYGVkZ2UtbGFtYmRhLXN0YWNrLSR7c3RhY2subm9kZS5hZGRyfWApIGFzIGNkay5TdGFjaztcbn1cbiJdfQ==