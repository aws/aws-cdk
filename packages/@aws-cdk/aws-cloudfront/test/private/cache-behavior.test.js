"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lambda = require("@aws-cdk/aws-lambda");
const core_1 = require("@aws-cdk/core");
const lib_1 = require("../../lib");
const cache_behavior_1 = require("../../lib/private/cache-behavior");
let app;
let stack;
const publicKey = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAudf8/iNkQgdvjEdm6xYS
JAyxd/kGTbJfQNg9YhInb7TSm0dGu0yx8yZ3fnpmxuRPqJIlaVr+fT4YRl71gEYa
dlhHmnVegyPNjP9dNqZ7zwNqMEPOPnS/NOHbJj1KYKpn1f8pPNycQ5MQCntKGnSj
6fc+nbcC0joDvGz80xuy1W4hLV9oC9c3GT26xfZb2jy9MVtA3cppNuTwqrFi3t6e
0iGpraxZlT5wewjZLpQkngqYr6s3aucPAZVsGTEYPo4nD5mswmtZOm+tgcOrivtD
/3sD/qZLQ6c5siqyS8aTraD6y+VXugujfarTU65IeZ6QAUbLMsWuZOIi5Jn8zAwx
NQIDAQAB
-----END PUBLIC KEY-----`;
beforeEach(() => {
    app = new core_1.App();
    stack = new core_1.Stack(app, 'Stack', {
        env: { account: '1234', region: 'testregion' },
    });
});
test('renders the minimum template with an origin and path specified', () => {
    const behavior = new cache_behavior_1.CacheBehavior('origin_id', {
        pathPattern: '*',
    });
    expect(behavior._renderBehavior()).toEqual({
        targetOriginId: 'origin_id',
        cachePolicyId: '658327ea-f89d-4fab-a63d-7e88639e58f6',
        compress: true,
        pathPattern: '*',
        viewerProtocolPolicy: 'allow-all',
    });
});
test('renders with all properties specified', () => {
    const fnVersion = lambda.Version.fromVersionArn(stack, 'Version', 'arn:aws:lambda:testregion:111111111111:function:myTestFun:v1');
    const pubKey = new lib_1.PublicKey(stack, 'MyPublicKey', {
        encodedKey: publicKey,
    });
    const keyGroup = new lib_1.KeyGroup(stack, 'MyKeyGroup', {
        items: [
            pubKey,
        ],
    });
    const behavior = new cache_behavior_1.CacheBehavior('origin_id', {
        pathPattern: '*',
        allowedMethods: lib_1.AllowedMethods.ALLOW_ALL,
        cachedMethods: lib_1.CachedMethods.CACHE_GET_HEAD_OPTIONS,
        cachePolicy: lib_1.CachePolicy.CACHING_OPTIMIZED,
        compress: true,
        originRequestPolicy: lib_1.OriginRequestPolicy.ALL_VIEWER,
        smoothStreaming: true,
        viewerProtocolPolicy: lib_1.ViewerProtocolPolicy.HTTPS_ONLY,
        edgeLambdas: [{
                eventType: lib_1.LambdaEdgeEventType.ORIGIN_REQUEST,
                includeBody: true,
                functionVersion: fnVersion,
            }],
        trustedKeyGroups: [keyGroup],
    });
    expect(behavior._renderBehavior()).toEqual({
        targetOriginId: 'origin_id',
        pathPattern: '*',
        allowedMethods: ['GET', 'HEAD', 'OPTIONS', 'PUT', 'PATCH', 'POST', 'DELETE'],
        cachedMethods: ['GET', 'HEAD', 'OPTIONS'],
        cachePolicyId: '658327ea-f89d-4fab-a63d-7e88639e58f6',
        compress: true,
        originRequestPolicyId: '216adef6-5c7f-47e4-b989-5492eafa07d3',
        smoothStreaming: true,
        viewerProtocolPolicy: 'https-only',
        lambdaFunctionAssociations: [{
                lambdaFunctionArn: 'arn:aws:lambda:testregion:111111111111:function:myTestFun:v1',
                eventType: 'origin-request',
                includeBody: true,
            }],
        trustedKeyGroups: [
            keyGroup.keyGroupId,
        ],
    });
});
test('throws if edgeLambda includeBody is set for wrong event type', () => {
    const fnVersion = lambda.Version.fromVersionArn(stack, 'Version', 'arn:aws:lambda:testregion:111111111111:function:myTestFun:v1');
    expect(() => new cache_behavior_1.CacheBehavior('origin_id', {
        pathPattern: '*',
        edgeLambdas: [{
                eventType: lib_1.LambdaEdgeEventType.ORIGIN_RESPONSE,
                includeBody: true,
                functionVersion: fnVersion,
            }],
    })).toThrow(/'includeBody' can only be true for ORIGIN_REQUEST or VIEWER_REQUEST event types./);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtYmVoYXZpb3IudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhY2hlLWJlaGF2aW9yLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBOEM7QUFDOUMsd0NBQTJDO0FBQzNDLG1DQUE0SjtBQUM1SixxRUFBaUU7QUFFakUsSUFBSSxHQUFRLENBQUM7QUFDYixJQUFJLEtBQVksQ0FBQztBQUNqQixNQUFNLFNBQVMsR0FBRzs7Ozs7Ozs7eUJBUU8sQ0FBQztBQUUxQixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7SUFDaEIsS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUU7UUFDOUIsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFO0tBQy9DLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGdFQUFnRSxFQUFFLEdBQUcsRUFBRTtJQUMxRSxNQUFNLFFBQVEsR0FBRyxJQUFJLDhCQUFhLENBQUMsV0FBVyxFQUFFO1FBQzlDLFdBQVcsRUFBRSxHQUFHO0tBQ2pCLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDekMsY0FBYyxFQUFFLFdBQVc7UUFDM0IsYUFBYSxFQUFFLHNDQUFzQztRQUNyRCxRQUFRLEVBQUUsSUFBSTtRQUNkLFdBQVcsRUFBRSxHQUFHO1FBQ2hCLG9CQUFvQixFQUFFLFdBQVc7S0FDbEMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsdUNBQXVDLEVBQUUsR0FBRyxFQUFFO0lBQ2pELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsOERBQThELENBQUMsQ0FBQztJQUNsSSxNQUFNLE1BQU0sR0FBRyxJQUFJLGVBQVMsQ0FBQyxLQUFLLEVBQUUsYUFBYSxFQUFFO1FBQ2pELFVBQVUsRUFBRSxTQUFTO0tBQ3RCLENBQUMsQ0FBQztJQUNILE1BQU0sUUFBUSxHQUFHLElBQUksY0FBUSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUU7UUFDakQsS0FBSyxFQUFFO1lBQ0wsTUFBTTtTQUNQO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSw4QkFBYSxDQUFDLFdBQVcsRUFBRTtRQUM5QyxXQUFXLEVBQUUsR0FBRztRQUNoQixjQUFjLEVBQUUsb0JBQWMsQ0FBQyxTQUFTO1FBQ3hDLGFBQWEsRUFBRSxtQkFBYSxDQUFDLHNCQUFzQjtRQUNuRCxXQUFXLEVBQUUsaUJBQVcsQ0FBQyxpQkFBaUI7UUFDMUMsUUFBUSxFQUFFLElBQUk7UUFDZCxtQkFBbUIsRUFBRSx5QkFBbUIsQ0FBQyxVQUFVO1FBQ25ELGVBQWUsRUFBRSxJQUFJO1FBQ3JCLG9CQUFvQixFQUFFLDBCQUFvQixDQUFDLFVBQVU7UUFDckQsV0FBVyxFQUFFLENBQUM7Z0JBQ1osU0FBUyxFQUFFLHlCQUFtQixDQUFDLGNBQWM7Z0JBQzdDLFdBQVcsRUFBRSxJQUFJO2dCQUNqQixlQUFlLEVBQUUsU0FBUzthQUMzQixDQUFDO1FBQ0YsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLENBQUM7S0FDN0IsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxjQUFjLEVBQUUsV0FBVztRQUMzQixXQUFXLEVBQUUsR0FBRztRQUNoQixjQUFjLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUM7UUFDNUUsYUFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUM7UUFDekMsYUFBYSxFQUFFLHNDQUFzQztRQUNyRCxRQUFRLEVBQUUsSUFBSTtRQUNkLHFCQUFxQixFQUFFLHNDQUFzQztRQUM3RCxlQUFlLEVBQUUsSUFBSTtRQUNyQixvQkFBb0IsRUFBRSxZQUFZO1FBQ2xDLDBCQUEwQixFQUFFLENBQUM7Z0JBQzNCLGlCQUFpQixFQUFFLDhEQUE4RDtnQkFDakYsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0IsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQztRQUNGLGdCQUFnQixFQUFFO1lBQ2hCLFFBQVEsQ0FBQyxVQUFVO1NBQ3BCO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsOERBQThELEVBQUUsR0FBRyxFQUFFO0lBQ3hFLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsOERBQThELENBQUMsQ0FBQztJQUVsSSxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSw4QkFBYSxDQUFDLFdBQVcsRUFBRTtRQUMxQyxXQUFXLEVBQUUsR0FBRztRQUNoQixXQUFXLEVBQUUsQ0FBQztnQkFDWixTQUFTLEVBQUUseUJBQW1CLENBQUMsZUFBZTtnQkFDOUMsV0FBVyxFQUFFLElBQUk7Z0JBQ2pCLGVBQWUsRUFBRSxTQUFTO2FBQzNCLENBQUM7S0FDSCxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsa0ZBQWtGLENBQUMsQ0FBQztBQUNsRyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEFwcCwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IEFsbG93ZWRNZXRob2RzLCBDYWNoZWRNZXRob2RzLCBDYWNoZVBvbGljeSwgS2V5R3JvdXAsIExhbWJkYUVkZ2VFdmVudFR5cGUsIE9yaWdpblJlcXVlc3RQb2xpY3ksIFB1YmxpY0tleSwgVmlld2VyUHJvdG9jb2xQb2xpY3kgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgQ2FjaGVCZWhhdmlvciB9IGZyb20gJy4uLy4uL2xpYi9wcml2YXRlL2NhY2hlLWJlaGF2aW9yJztcblxubGV0IGFwcDogQXBwO1xubGV0IHN0YWNrOiBTdGFjaztcbmNvbnN0IHB1YmxpY0tleSA9IGAtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF1ZGY4L2lOa1FnZHZqRWRtNnhZU1xuSkF5eGQva0dUYkpmUU5nOVloSW5iN1RTbTBkR3UweXg4eVozZm5wbXh1UlBxSklsYVZyK2ZUNFlSbDcxZ0VZYVxuZGxoSG1uVmVneVBOalA5ZE5xWjd6d05xTUVQT1BuUy9OT0hiSmoxS1lLcG4xZjhwUE55Y1E1TVFDbnRLR25TalxuNmZjK25iY0Mwam9Edkd6ODB4dXkxVzRoTFY5b0M5YzNHVDI2eGZaYjJqeTlNVnRBM2NwcE51VHdxckZpM3Q2ZVxuMGlHcHJheFpsVDV3ZXdqWkxwUWtuZ3FZcjZzM2F1Y1BBWlZzR1RFWVBvNG5ENW1zd210Wk9tK3RnY09yaXZ0RFxuLzNzRC9xWkxRNmM1c2lxeVM4YVRyYUQ2eStWWHVndWpmYXJUVTY1SWVaNlFBVWJMTXNXdVpPSWk1Sm44ekF3eFxuTlFJREFRQUJcbi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLWA7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBhcHAgPSBuZXcgQXBwKCk7XG4gIHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgIGVudjogeyBhY2NvdW50OiAnMTIzNCcsIHJlZ2lvbjogJ3Rlc3RyZWdpb24nIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ3JlbmRlcnMgdGhlIG1pbmltdW0gdGVtcGxhdGUgd2l0aCBhbiBvcmlnaW4gYW5kIHBhdGggc3BlY2lmaWVkJywgKCkgPT4ge1xuICBjb25zdCBiZWhhdmlvciA9IG5ldyBDYWNoZUJlaGF2aW9yKCdvcmlnaW5faWQnLCB7XG4gICAgcGF0aFBhdHRlcm46ICcqJyxcbiAgfSk7XG5cbiAgZXhwZWN0KGJlaGF2aW9yLl9yZW5kZXJCZWhhdmlvcigpKS50b0VxdWFsKHtcbiAgICB0YXJnZXRPcmlnaW5JZDogJ29yaWdpbl9pZCcsXG4gICAgY2FjaGVQb2xpY3lJZDogJzY1ODMyN2VhLWY4OWQtNGZhYi1hNjNkLTdlODg2MzllNThmNicsXG4gICAgY29tcHJlc3M6IHRydWUsXG4gICAgcGF0aFBhdHRlcm46ICcqJyxcbiAgICB2aWV3ZXJQcm90b2NvbFBvbGljeTogJ2FsbG93LWFsbCcsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ3JlbmRlcnMgd2l0aCBhbGwgcHJvcGVydGllcyBzcGVjaWZpZWQnLCAoKSA9PiB7XG4gIGNvbnN0IGZuVmVyc2lvbiA9IGxhbWJkYS5WZXJzaW9uLmZyb21WZXJzaW9uQXJuKHN0YWNrLCAnVmVyc2lvbicsICdhcm46YXdzOmxhbWJkYTp0ZXN0cmVnaW9uOjExMTExMTExMTExMTpmdW5jdGlvbjpteVRlc3RGdW46djEnKTtcbiAgY29uc3QgcHViS2V5ID0gbmV3IFB1YmxpY0tleShzdGFjaywgJ015UHVibGljS2V5Jywge1xuICAgIGVuY29kZWRLZXk6IHB1YmxpY0tleSxcbiAgfSk7XG4gIGNvbnN0IGtleUdyb3VwID0gbmV3IEtleUdyb3VwKHN0YWNrLCAnTXlLZXlHcm91cCcsIHtcbiAgICBpdGVtczogW1xuICAgICAgcHViS2V5LFxuICAgIF0sXG4gIH0pO1xuXG4gIGNvbnN0IGJlaGF2aW9yID0gbmV3IENhY2hlQmVoYXZpb3IoJ29yaWdpbl9pZCcsIHtcbiAgICBwYXRoUGF0dGVybjogJyonLFxuICAgIGFsbG93ZWRNZXRob2RzOiBBbGxvd2VkTWV0aG9kcy5BTExPV19BTEwsXG4gICAgY2FjaGVkTWV0aG9kczogQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgIGNhY2hlUG9saWN5OiBDYWNoZVBvbGljeS5DQUNISU5HX09QVElNSVpFRCxcbiAgICBjb21wcmVzczogdHJ1ZSxcbiAgICBvcmlnaW5SZXF1ZXN0UG9saWN5OiBPcmlnaW5SZXF1ZXN0UG9saWN5LkFMTF9WSUVXRVIsXG4gICAgc21vb3RoU3RyZWFtaW5nOiB0cnVlLFxuICAgIHZpZXdlclByb3RvY29sUG9saWN5OiBWaWV3ZXJQcm90b2NvbFBvbGljeS5IVFRQU19PTkxZLFxuICAgIGVkZ2VMYW1iZGFzOiBbe1xuICAgICAgZXZlbnRUeXBlOiBMYW1iZGFFZGdlRXZlbnRUeXBlLk9SSUdJTl9SRVFVRVNULFxuICAgICAgaW5jbHVkZUJvZHk6IHRydWUsXG4gICAgICBmdW5jdGlvblZlcnNpb246IGZuVmVyc2lvbixcbiAgICB9XSxcbiAgICB0cnVzdGVkS2V5R3JvdXBzOiBba2V5R3JvdXBdLFxuICB9KTtcblxuICBleHBlY3QoYmVoYXZpb3IuX3JlbmRlckJlaGF2aW9yKCkpLnRvRXF1YWwoe1xuICAgIHRhcmdldE9yaWdpbklkOiAnb3JpZ2luX2lkJyxcbiAgICBwYXRoUGF0dGVybjogJyonLFxuICAgIGFsbG93ZWRNZXRob2RzOiBbJ0dFVCcsICdIRUFEJywgJ09QVElPTlMnLCAnUFVUJywgJ1BBVENIJywgJ1BPU1QnLCAnREVMRVRFJ10sXG4gICAgY2FjaGVkTWV0aG9kczogWydHRVQnLCAnSEVBRCcsICdPUFRJT05TJ10sXG4gICAgY2FjaGVQb2xpY3lJZDogJzY1ODMyN2VhLWY4OWQtNGZhYi1hNjNkLTdlODg2MzllNThmNicsXG4gICAgY29tcHJlc3M6IHRydWUsXG4gICAgb3JpZ2luUmVxdWVzdFBvbGljeUlkOiAnMjE2YWRlZjYtNWM3Zi00N2U0LWI5ODktNTQ5MmVhZmEwN2QzJyxcbiAgICBzbW9vdGhTdHJlYW1pbmc6IHRydWUsXG4gICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6ICdodHRwcy1vbmx5JyxcbiAgICBsYW1iZGFGdW5jdGlvbkFzc29jaWF0aW9uczogW3tcbiAgICAgIGxhbWJkYUZ1bmN0aW9uQXJuOiAnYXJuOmF3czpsYW1iZGE6dGVzdHJlZ2lvbjoxMTExMTExMTExMTE6ZnVuY3Rpb246bXlUZXN0RnVuOnYxJyxcbiAgICAgIGV2ZW50VHlwZTogJ29yaWdpbi1yZXF1ZXN0JyxcbiAgICAgIGluY2x1ZGVCb2R5OiB0cnVlLFxuICAgIH1dLFxuICAgIHRydXN0ZWRLZXlHcm91cHM6IFtcbiAgICAgIGtleUdyb3VwLmtleUdyb3VwSWQsXG4gICAgXSxcbiAgfSk7XG59KTtcblxudGVzdCgndGhyb3dzIGlmIGVkZ2VMYW1iZGEgaW5jbHVkZUJvZHkgaXMgc2V0IGZvciB3cm9uZyBldmVudCB0eXBlJywgKCkgPT4ge1xuICBjb25zdCBmblZlcnNpb24gPSBsYW1iZGEuVmVyc2lvbi5mcm9tVmVyc2lvbkFybihzdGFjaywgJ1ZlcnNpb24nLCAnYXJuOmF3czpsYW1iZGE6dGVzdHJlZ2lvbjoxMTExMTExMTExMTE6ZnVuY3Rpb246bXlUZXN0RnVuOnYxJyk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBDYWNoZUJlaGF2aW9yKCdvcmlnaW5faWQnLCB7XG4gICAgcGF0aFBhdHRlcm46ICcqJyxcbiAgICBlZGdlTGFtYmRhczogW3tcbiAgICAgIGV2ZW50VHlwZTogTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVTUE9OU0UsXG4gICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgIGZ1bmN0aW9uVmVyc2lvbjogZm5WZXJzaW9uLFxuICAgIH1dLFxuICB9KSkudG9UaHJvdygvJ2luY2x1ZGVCb2R5JyBjYW4gb25seSBiZSB0cnVlIGZvciBPUklHSU5fUkVRVUVTVCBvciBWSUVXRVJfUkVRVUVTVCBldmVudCB0eXBlcy4vKTtcbn0pO1xuIl19