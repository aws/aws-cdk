"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("@aws-cdk/assertions");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const iam = require("@aws-cdk/aws-iam");
const core_1 = require("@aws-cdk/core");
const constructs_1 = require("constructs");
const alias_1 = require("../lib/alias");
const key_1 = require("../lib/key");
test('default alias', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'Key');
    new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('add "alias/" prefix if not given.', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'Key', {
        enableKeyRotation: true,
        enabled: false,
    });
    new alias_1.Alias(stack, 'Alias', {
        aliasName: 'foo',
        targetKey: key,
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('can create alias directly while creating the key', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    new key_1.Key(stack, 'Key', {
        enableKeyRotation: true,
        enabled: false,
        alias: 'foo',
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('fails if alias is "alias/" (and nothing more)', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias', {
        aliasName: 'alias/',
        targetKey: key,
    })).toThrow(/Alias must include a value after/);
});
test('fails if alias contains illegal characters', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias', {
        aliasName: 'alias/@Nope',
        targetKey: key,
    })).toThrow('a-zA-Z0-9:/_-');
});
test('fails if alias starts with "alias/aws/"', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias1', {
        aliasName: 'alias/aws/',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/aws\//);
    expect(() => new alias_1.Alias(stack, 'Alias2', {
        aliasName: 'alias/aws/Awesome',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/aws\/Awesome/);
    expect(() => new alias_1.Alias(stack, 'Alias3', {
        aliasName: 'alias/AWS/awesome',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/AWS\/awesome/);
});
test('can be used wherever a key is expected', () => {
    const stack = new core_1.Stack();
    const myKey = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    const myAlias = new alias_1.Alias(stack, 'MyAlias', {
        targetKey: myKey,
        aliasName: 'alias/myAlias',
    });
    /* eslint-disable @aws-cdk/no-core-construct */
    class MyConstruct extends constructs_1.Construct {
        constructor(scope, id, key) {
            super(scope, id);
            new core_1.CfnOutput(stack, 'OutId', {
                value: key.keyId,
            });
            new core_1.CfnOutput(stack, 'OutArn', {
                value: key.keyArn,
            });
        }
    }
    new MyConstruct(stack, 'MyConstruct', myAlias);
    /* eslint-enable @aws-cdk/no-core-construct */
    assertions_1.Template.fromStack(stack).hasOutput('OutId', {
        Value: 'alias/myAlias',
    });
    assertions_1.Template.fromStack(stack).hasOutput('OutArn', {
        Value: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    ':kms:',
                    { Ref: 'AWS::Region' },
                    ':',
                    { Ref: 'AWS::AccountId' },
                    ':alias/myAlias',
                ]],
        },
    });
});
test('imported alias by name - can be used where a key is expected', () => {
    const stack = new core_1.Stack();
    const myAlias = alias_1.Alias.fromAliasName(stack, 'MyAlias', 'alias/myAlias');
    /* eslint-disable @aws-cdk/no-core-construct */
    class MyConstruct extends constructs_1.Construct {
        constructor(scope, id, key) {
            super(scope, id);
            new core_1.CfnOutput(stack, 'OutId', {
                value: key.keyId,
            });
            new core_1.CfnOutput(stack, 'OutArn', {
                value: key.keyArn,
            });
        }
    }
    new MyConstruct(stack, 'MyConstruct', myAlias);
    /* eslint-enable @aws-cdk/no-core-construct */
    assertions_1.Template.fromStack(stack).hasOutput('OutId', {
        Value: 'alias/myAlias',
    });
    assertions_1.Template.fromStack(stack).hasOutput('OutArn', {
        Value: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    ':kms:',
                    { Ref: 'AWS::Region' },
                    ':',
                    { Ref: 'AWS::AccountId' },
                    ':alias/myAlias',
                ]],
        },
    });
});
test('imported alias by name - will throw an error when accessing the key', () => {
    const stack = new core_1.Stack();
    const myAlias = alias_1.Alias.fromAliasName(stack, 'MyAlias', 'alias/myAlias');
    expect(() => myAlias.aliasTargetKey).toThrow('Cannot access aliasTargetKey on an Alias imported by Alias.fromAliasName().');
});
test('fails if alias policy is invalid', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'my-stack');
    const key = new key_1.Key(stack, 'MyKey');
    const alias = new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    alias.addToResourcePolicy(new aws_iam_1.PolicyStatement({
        resources: ['*'],
        principals: [new aws_iam_1.ArnPrincipal('arn')],
    }));
    expect(() => app.synth()).toThrow(/A PolicyStatement must specify at least one \'action\' or \'notAction\'/);
});
test('grants generate mac to the alias target key', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'my-stack');
    const key = new key_1.Key(stack, 'Key');
    const alias = new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    const user = new iam.User(stack, 'User');
    alias.grantGenerateMac(user);
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [
                {
                    Action: 'kms:GenerateMac',
                    Effect: 'Allow',
                    Resource: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
                },
            ],
            Version: '2012-10-17',
        },
    });
});
test('grants generate mac to the alias target key', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'my-stack');
    const key = new key_1.Key(stack, 'Key');
    const alias = new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    const user = new iam.User(stack, 'User');
    alias.grantVerifyMac(user);
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [
                {
                    Action: 'kms:VerifyMac',
                    Effect: 'Allow',
                    Resource: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
                },
            ],
            Version: '2012-10-17',
        },
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxpYXMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFsaWFzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREFBK0M7QUFDL0MsOENBQWlFO0FBQ2pFLHdDQUF3QztBQUN4Qyx3Q0FBc0Q7QUFDdEQsMkNBQXVDO0FBQ3ZDLHdDQUFxQztBQUNyQyxvQ0FBdUM7QUFFdkMsSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDekIsTUFBTSxHQUFHLEdBQUcsSUFBSSxVQUFHLEVBQUUsQ0FBQztJQUN0QixNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDckMsTUFBTSxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRWxDLElBQUksYUFBSyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBRXRFLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLGlCQUFpQixFQUFFO1FBQ2pFLFNBQVMsRUFBRSxXQUFXO1FBQ3RCLFdBQVcsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRTtLQUN0RCxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7SUFDN0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxVQUFHLEVBQUUsQ0FBQztJQUN0QixNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFckMsTUFBTSxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRTtRQUNoQyxpQkFBaUIsRUFBRSxJQUFJO1FBQ3ZCLE9B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LENBQUMsSUFBSSxDQUFDLENBQUM7SUFFM0IscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLEVBQUU7UUFDbEUsY0FBYyxFQUFFO1lBQ2QsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE1BQU0sRUFBRSxlQUFlO29CQUN2QixNQUFNLEVBQUUsT0FBTztvQkFDZixRQUFRLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUU7aUJBQ25EO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsWUFBWTtTQUN0QjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICdAYXdzLWNkay9hc3NlcnRpb25zJztcbmltcG9ydCB7IEFyblByaW5jaXBhbCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgeyBBcHAsIENmbk91dHB1dCwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQWxpYXMgfSBmcm9tICcuLi9saWIvYWxpYXMnO1xuaW1wb3J0IHsgSUtleSwgS2V5IH0gZnJvbSAnLi4vbGliL2tleSc7XG5cbnRlc3QoJ2RlZmF1bHQgYWxpYXMnLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnVGVzdCcpO1xuICBjb25zdCBrZXkgPSBuZXcgS2V5KHN0YWNrLCAnS2V5Jyk7XG5cbiAgbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMnLCB7IHRhcmdldEtleToga2V5LCBhbGlhc05hbWU6ICdhbGlhcy9mb28nIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OktNUzo6QWxpYXMnLCB7XG4gICAgQWxpYXNOYW1lOiAnYWxpYXMvZm9vJyxcbiAgICBUYXJnZXRLZXlJZDogeyAnRm46OkdldEF0dCc6IFsnS2V5OTYxQjczRkQnLCAnQXJuJ10gfSxcbiAgfSk7XG59KTtcblxudGVzdCgnYWRkIFwiYWxpYXMvXCIgcHJlZml4IGlmIG5vdCBnaXZlbi4nLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnVGVzdCcpO1xuXG4gIGNvbnN0IGtleSA9IG5ldyBLZXkoc3RhY2ssICdLZXknLCB7XG4gICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgZW5hYmxlZDogZmFsc2UsXG4gIH0pO1xuXG4gIG5ldyBBbGlhcyhzdGFjaywgJ0FsaWFzJywge1xuICAgIGFsaWFzTmFtZTogJ2ZvbycsXG4gICAgdGFyZ2V0S2V5OiBrZXksXG4gIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OktNUzo6QWxpYXMnLCB7XG4gICAgQWxpYXNOYW1lOiAnYWxpYXMvZm9vJyxcbiAgICBUYXJnZXRLZXlJZDogeyAnRm46OkdldEF0dCc6IFsnS2V5OTYxQjczRkQnLCAnQXJuJ10gfSxcbiAgfSk7XG59KTtcblxudGVzdCgnY2FuIGNyZWF0ZSBhbGlhcyBkaXJlY3RseSB3aGlsZSBjcmVhdGluZyB0aGUga2V5JywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1Rlc3QnKTtcblxuICBuZXcgS2V5KHN0YWNrLCAnS2V5Jywge1xuICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgIGFsaWFzOiAnZm9vJyxcbiAgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6S01TOjpBbGlhcycsIHtcbiAgICBBbGlhc05hbWU6ICdhbGlhcy9mb28nLFxuICAgIFRhcmdldEtleUlkOiB7ICdGbjo6R2V0QXR0JzogWydLZXk5NjFCNzNGRCcsICdBcm4nXSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiBhbGlhcyBpcyBcImFsaWFzL1wiIChhbmQgbm90aGluZyBtb3JlKScsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdUZXN0Jyk7XG5cbiAgY29uc3Qga2V5ID0gbmV3IEtleShzdGFjaywgJ015S2V5Jywge1xuICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgIGVuYWJsZWQ6IGZhbHNlLFxuICB9KTtcblxuICBleHBlY3QoKCkgPT4gbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMnLCB7XG4gICAgYWxpYXNOYW1lOiAnYWxpYXMvJyxcbiAgICB0YXJnZXRLZXk6IGtleSxcbiAgfSkpLnRvVGhyb3coL0FsaWFzIG11c3QgaW5jbHVkZSBhIHZhbHVlIGFmdGVyLyk7XG59KTtcblxudGVzdCgnZmFpbHMgaWYgYWxpYXMgY29udGFpbnMgaWxsZWdhbCBjaGFyYWN0ZXJzJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1Rlc3QnKTtcblxuICBjb25zdCBrZXkgPSBuZXcgS2V5KHN0YWNrLCAnTXlLZXknLCB7XG4gICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgZW5hYmxlZDogZmFsc2UsXG4gIH0pO1xuXG4gIGV4cGVjdCgoKSA9PiBuZXcgQWxpYXMoc3RhY2ssICdBbGlhcycsIHtcbiAgICBhbGlhc05hbWU6ICdhbGlhcy9ATm9wZScsXG4gICAgdGFyZ2V0S2V5OiBrZXksXG4gIH0pKS50b1Rocm93KCdhLXpBLVowLTk6L18tJyk7XG59KTtcblxudGVzdCgnZmFpbHMgaWYgYWxpYXMgc3RhcnRzIHdpdGggXCJhbGlhcy9hd3MvXCInLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnVGVzdCcpO1xuXG4gIGNvbnN0IGtleSA9IG5ldyBLZXkoc3RhY2ssICdNeUtleScsIHtcbiAgICBlbmFibGVLZXlSb3RhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVkOiBmYWxzZSxcbiAgfSk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBBbGlhcyhzdGFjaywgJ0FsaWFzMScsIHtcbiAgICBhbGlhc05hbWU6ICdhbGlhcy9hd3MvJyxcbiAgICB0YXJnZXRLZXk6IGtleSxcbiAgfSkpLnRvVGhyb3coL0FsaWFzIGNhbm5vdCBzdGFydCB3aXRoIGFsaWFzXFwvYXdzXFwvOiBhbGlhc1xcL2F3c1xcLy8pO1xuXG4gIGV4cGVjdCgoKSA9PiBuZXcgQWxpYXMoc3RhY2ssICdBbGlhczInLCB7XG4gICAgYWxpYXNOYW1lOiAnYWxpYXMvYXdzL0F3ZXNvbWUnLFxuICAgIHRhcmdldEtleToga2V5LFxuICB9KSkudG9UaHJvdygvQWxpYXMgY2Fubm90IHN0YXJ0IHdpdGggYWxpYXNcXC9hd3NcXC86IGFsaWFzXFwvYXdzXFwvQXdlc29tZS8pO1xuXG4gIGV4cGVjdCgoKSA9PiBuZXcgQWxpYXMoc3RhY2ssICdBbGlhczMnLCB7XG4gICAgYWxpYXNOYW1lOiAnYWxpYXMvQVdTL2F3ZXNvbWUnLFxuICAgIHRhcmdldEtleToga2V5LFxuICB9KSkudG9UaHJvdygvQWxpYXMgY2Fubm90IHN0YXJ0IHdpdGggYWxpYXNcXC9hd3NcXC86IGFsaWFzXFwvQVdTXFwvYXdlc29tZS8pO1xufSk7XG5cbnRlc3QoJ2NhbiBiZSB1c2VkIHdoZXJldmVyIGEga2V5IGlzIGV4cGVjdGVkJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIGNvbnN0IG15S2V5ID0gbmV3IEtleShzdGFjaywgJ015S2V5Jywge1xuICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgIGVuYWJsZWQ6IGZhbHNlLFxuICB9KTtcbiAgY29uc3QgbXlBbGlhcyA9IG5ldyBBbGlhcyhzdGFjaywgJ015QWxpYXMnLCB7XG4gICAgdGFyZ2V0S2V5OiBteUtleSxcbiAgICBhbGlhc05hbWU6ICdhbGlhcy9teUFsaWFzJyxcbiAgfSk7XG5cbiAgLyogZXNsaW50LWRpc2FibGUgQGF3cy1jZGsvbm8tY29yZS1jb25zdHJ1Y3QgKi9cbiAgY2xhc3MgTXlDb25zdHJ1Y3QgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIGtleTogSUtleSkge1xuICAgICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgICAgbmV3IENmbk91dHB1dChzdGFjaywgJ091dElkJywge1xuICAgICAgICB2YWx1ZToga2V5LmtleUlkLFxuICAgICAgfSk7XG4gICAgICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCAnT3V0QXJuJywge1xuICAgICAgICB2YWx1ZToga2V5LmtleUFybixcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICBuZXcgTXlDb25zdHJ1Y3Qoc3RhY2ssICdNeUNvbnN0cnVjdCcsIG15QWxpYXMpO1xuICAvKiBlc2xpbnQtZW5hYmxlIEBhd3MtY2RrL25vLWNvcmUtY29uc3RydWN0ICovXG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNPdXRwdXQoJ091dElkJywge1xuICAgIFZhbHVlOiAnYWxpYXMvbXlBbGlhcycsXG4gIH0pO1xuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc091dHB1dCgnT3V0QXJuJywge1xuICAgIFZhbHVlOiB7XG4gICAgICAnRm46OkpvaW4nOiBbJycsIFtcbiAgICAgICAgJ2FybjonLFxuICAgICAgICB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LFxuICAgICAgICAnOmttczonLFxuICAgICAgICB7IFJlZjogJ0FXUzo6UmVnaW9uJyB9LFxuICAgICAgICAnOicsXG4gICAgICAgIHsgUmVmOiAnQVdTOjpBY2NvdW50SWQnIH0sXG4gICAgICAgICc6YWxpYXMvbXlBbGlhcycsXG4gICAgICBdXSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdpbXBvcnRlZCBhbGlhcyBieSBuYW1lIC0gY2FuIGJlIHVzZWQgd2hlcmUgYSBrZXkgaXMgZXhwZWN0ZWQnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgY29uc3QgbXlBbGlhcyA9IEFsaWFzLmZyb21BbGlhc05hbWUoc3RhY2ssICdNeUFsaWFzJywgJ2FsaWFzL215QWxpYXMnKTtcblxuICAvKiBlc2xpbnQtZGlzYWJsZSBAYXdzLWNkay9uby1jb3JlLWNvbnN0cnVjdCAqL1xuICBjbGFzcyBNeUNvbnN0cnVjdCBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywga2V5OiBJS2V5KSB7XG4gICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCAnT3V0SWQnLCB7XG4gICAgICAgIHZhbHVlOiBrZXkua2V5SWQsXG4gICAgICB9KTtcbiAgICAgIG5ldyBDZm5PdXRwdXQoc3RhY2ssICdPdXRBcm4nLCB7XG4gICAgICAgIHZhbHVlOiBrZXkua2V5QXJuLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIG5ldyBNeUNvbnN0cnVjdChzdGFjaywgJ015Q29uc3RydWN0JywgbXlBbGlhcyk7XG4gIC8qIGVzbGludC1lbmFibGUgQGF3cy1jZGsvbm8tY29yZS1jb25zdHJ1Y3QgKi9cblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc091dHB1dCgnT3V0SWQnLCB7XG4gICAgVmFsdWU6ICdhbGlhcy9teUFsaWFzJyxcbiAgfSk7XG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KCdPdXRBcm4nLCB7XG4gICAgVmFsdWU6IHtcbiAgICAgICdGbjo6Sm9pbic6IFsnJywgW1xuICAgICAgICAnYXJuOicsXG4gICAgICAgIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sXG4gICAgICAgICc6a21zOicsXG4gICAgICAgIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sXG4gICAgICAgICc6JyxcbiAgICAgICAgeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSxcbiAgICAgICAgJzphbGlhcy9teUFsaWFzJyxcbiAgICAgIF1dLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2ltcG9ydGVkIGFsaWFzIGJ5IG5hbWUgLSB3aWxsIHRocm93IGFuIGVycm9yIHdoZW4gYWNjZXNzaW5nIHRoZSBrZXknLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgY29uc3QgbXlBbGlhcyA9IEFsaWFzLmZyb21BbGlhc05hbWUoc3RhY2ssICdNeUFsaWFzJywgJ2FsaWFzL215QWxpYXMnKTtcblxuICBleHBlY3QoKCkgPT4gbXlBbGlhcy5hbGlhc1RhcmdldEtleSkudG9UaHJvdygnQ2Fubm90IGFjY2VzcyBhbGlhc1RhcmdldEtleSBvbiBhbiBBbGlhcyBpbXBvcnRlZCBieSBBbGlhcy5mcm9tQWxpYXNOYW1lKCkuJyk7XG59KTtcblxudGVzdCgnZmFpbHMgaWYgYWxpYXMgcG9saWN5IGlzIGludmFsaWQnLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnbXktc3RhY2snKTtcbiAgY29uc3Qga2V5ID0gbmV3IEtleShzdGFjaywgJ015S2V5Jyk7XG4gIGNvbnN0IGFsaWFzID0gbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMnLCB7IHRhcmdldEtleToga2V5LCBhbGlhc05hbWU6ICdhbGlhcy9mb28nIH0pO1xuXG4gIGFsaWFzLmFkZFRvUmVzb3VyY2VQb2xpY3kobmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICBwcmluY2lwYWxzOiBbbmV3IEFyblByaW5jaXBhbCgnYXJuJyldLFxuICB9KSk7XG5cbiAgZXhwZWN0KCgpID0+IGFwcC5zeW50aCgpKS50b1Rocm93KC9BIFBvbGljeVN0YXRlbWVudCBtdXN0IHNwZWNpZnkgYXQgbGVhc3Qgb25lIFxcJ2FjdGlvblxcJyBvciBcXCdub3RBY3Rpb25cXCcvKTtcbn0pO1xuXG50ZXN0KCdncmFudHMgZ2VuZXJhdGUgbWFjIHRvIHRoZSBhbGlhcyB0YXJnZXQga2V5JywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ215LXN0YWNrJyk7XG4gIGNvbnN0IGtleSA9IG5ldyBLZXkoc3RhY2ssICdLZXknKTtcbiAgY29uc3QgYWxpYXMgPSBuZXcgQWxpYXMoc3RhY2ssICdBbGlhcycsIHsgdGFyZ2V0S2V5OiBrZXksIGFsaWFzTmFtZTogJ2FsaWFzL2ZvbycgfSk7XG4gIGNvbnN0IHVzZXIgPSBuZXcgaWFtLlVzZXIoc3RhY2ssICdVc2VyJyk7XG5cbiAgYWxpYXMuZ3JhbnRHZW5lcmF0ZU1hYyh1c2VyKTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246ICdrbXM6R2VuZXJhdGVNYWMnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZTogeyAnRm46OkdldEF0dCc6IFsnS2V5OTYxQjczRkQnLCAnQXJuJ10gfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnZ3JhbnRzIGdlbmVyYXRlIG1hYyB0byB0aGUgYWxpYXMgdGFyZ2V0IGtleScsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdteS1zdGFjaycpO1xuICBjb25zdCBrZXkgPSBuZXcgS2V5KHN0YWNrLCAnS2V5Jyk7XG4gIGNvbnN0IGFsaWFzID0gbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMnLCB7IHRhcmdldEtleToga2V5LCBhbGlhc05hbWU6ICdhbGlhcy9mb28nIH0pO1xuICBjb25zdCB1c2VyID0gbmV3IGlhbS5Vc2VyKHN0YWNrLCAnVXNlcicpO1xuXG4gIGFsaWFzLmdyYW50VmVyaWZ5TWFjKHVzZXIpO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogJ2ttczpWZXJpZnlNYWMnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZTogeyAnRm46OkdldEF0dCc6IFsnS2V5OTYxQjczRkQnLCAnQXJuJ10gfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgfSxcbiAgfSk7XG59KTtcblxuIl19