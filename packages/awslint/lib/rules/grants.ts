import { Linter } from '../linter';
import { memberFqn } from './util';

/**
 * These are the grant methods that already existed when this linter was created.
 */
const allowList = new Set([
  '@aws-cdk/example-construct-library.ExampleResource.grantRead',
  'aws-cdk-lib.aws_apigateway.ApiKey.grantRead',
  'aws-cdk-lib.aws_apigateway.ApiKey.grantReadWrite',
  'aws-cdk-lib.aws_apigateway.ApiKey.grantWrite',
  'aws-cdk-lib.aws_apigateway.Method.grantExecute',
  'aws-cdk-lib.aws_apigateway.RateLimitedApiKey.grantRead',
  'aws-cdk-lib.aws_apigateway.RateLimitedApiKey.grantReadWrite',
  'aws-cdk-lib.aws_apigateway.RateLimitedApiKey.grantWrite',
  'aws-cdk-lib.aws_apigatewayv2.ApiKey.grantRead',
  'aws-cdk-lib.aws_apigatewayv2.ApiKey.grantReadWrite',
  'aws-cdk-lib.aws_apigatewayv2.ApiKey.grantWrite',
  'aws-cdk-lib.aws_apigatewayv2.HttpRoute.grantInvoke',
  'aws-cdk-lib.aws_apigatewayv2.RateLimitedApiKey.grantRead',
  'aws-cdk-lib.aws_apigatewayv2.RateLimitedApiKey.grantReadWrite',
  'aws-cdk-lib.aws_apigatewayv2.RateLimitedApiKey.grantWrite',
  'aws-cdk-lib.aws_apigatewayv2.WebSocketApi.grantManageConnections',
  'aws-cdk-lib.aws_apigatewayv2.WebSocketStage.grantManagementApiAccess',
  'aws-cdk-lib.aws_appconfig.Environment.grant',
  'aws-cdk-lib.aws_appconfig.Environment.grantReadConfig',
  'aws-cdk-lib.aws_appmesh.VirtualGateway.grantStreamAggregatedResources',
  'aws-cdk-lib.aws_appmesh.VirtualNode.grantStreamAggregatedResources',
  'aws-cdk-lib.aws_appsync.ChannelNamespace.grantPublish',
  'aws-cdk-lib.aws_appsync.ChannelNamespace.grantPublishAndSubscribe',
  'aws-cdk-lib.aws_appsync.ChannelNamespace.grantSubscribe',
  'aws-cdk-lib.aws_appsync.EventApi.grant',
  'aws-cdk-lib.aws_appsync.EventApi.grantConnect',
  'aws-cdk-lib.aws_appsync.EventApi.grantPublish',
  'aws-cdk-lib.aws_appsync.EventApi.grantPublishAndSubscribe',
  'aws-cdk-lib.aws_appsync.EventApi.grantSubscribe',
  'aws-cdk-lib.aws_appsync.EventApiBase.grant',
  'aws-cdk-lib.aws_appsync.EventApiBase.grantConnect',
  'aws-cdk-lib.aws_appsync.EventApiBase.grantPublish',
  'aws-cdk-lib.aws_appsync.EventApiBase.grantPublishAndSubscribe',
  'aws-cdk-lib.aws_appsync.EventApiBase.grantSubscribe',
  'aws-cdk-lib.aws_appsync.GraphqlApi.grant',
  'aws-cdk-lib.aws_appsync.GraphqlApi.grantMutation',
  'aws-cdk-lib.aws_appsync.GraphqlApi.grantQuery',
  'aws-cdk-lib.aws_appsync.GraphqlApi.grantSubscription',
  'aws-cdk-lib.aws_appsync.GraphqlApiBase.grant',
  'aws-cdk-lib.aws_appsync.GraphqlApiBase.grantMutation',
  'aws-cdk-lib.aws_appsync.GraphqlApiBase.grantQuery',
  'aws-cdk-lib.aws_appsync.GraphqlApiBase.grantSubscription',
  'aws-cdk-lib.aws_backup.BackupVault.grant',
  'aws-cdk-lib.aws_cloudfront.CloudFrontWebDistribution.grant',
  'aws-cdk-lib.aws_cloudfront.CloudFrontWebDistribution.grantCreateInvalidation',
  'aws-cdk-lib.aws_cloudfront.Distribution.grant',
  'aws-cdk-lib.aws_cloudfront.Distribution.grantCreateInvalidation',
  'aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.grantInvoke',
  'aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.grantInvokeUrl',
  'aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.grantInvokeVersion',
  'aws-cdk-lib.aws_codebuild.ReportGroup.grantWrite',
  'aws-cdk-lib.aws_codecommit.Repository.grant',
  'aws-cdk-lib.aws_codecommit.Repository.grantPull',
  'aws-cdk-lib.aws_codecommit.Repository.grantPullPush',
  'aws-cdk-lib.aws_codecommit.Repository.grantRead',
  'aws-cdk-lib.aws_codedeploy.LambdaDeploymentGroup.grantPutLifecycleEventHookExecutionStatus',
  'aws-cdk-lib.aws_codeguruprofiler.ProfilingGroup.grantPublish',
  'aws-cdk-lib.aws_codeguruprofiler.ProfilingGroup.grantRead',
  'aws-cdk-lib.aws_cognito.UserPool.grant',
  'aws-cdk-lib.aws_docdb.DatabaseSecret.grantRead',
  'aws-cdk-lib.aws_docdb.DatabaseSecret.grantWrite',
  'aws-cdk-lib.aws_dynamodb.Table.grant',
  'aws-cdk-lib.aws_dynamodb.Table.grantFullAccess',
  'aws-cdk-lib.aws_dynamodb.Table.grantReadData',
  'aws-cdk-lib.aws_dynamodb.Table.grantReadWriteData',
  'aws-cdk-lib.aws_dynamodb.Table.grantStream',
  'aws-cdk-lib.aws_dynamodb.Table.grantStreamRead',
  'aws-cdk-lib.aws_dynamodb.Table.grantTableListStreams',
  'aws-cdk-lib.aws_dynamodb.Table.grantWriteData',
  'aws-cdk-lib.aws_dynamodb.TableBase.grant',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantFullAccess',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantReadData',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantReadWriteData',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantStream',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantStreamRead',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantTableListStreams',
  'aws-cdk-lib.aws_dynamodb.TableBase.grantWriteData',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grant',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantFullAccess',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantReadData',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantReadWriteData',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantStream',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantStreamRead',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantTableListStreams',
  'aws-cdk-lib.aws_dynamodb.TableBaseV2.grantWriteData',
  'aws-cdk-lib.aws_dynamodb.TableV2.grant',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantFullAccess',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantReadData',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantReadWriteData',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantStream',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantStreamRead',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantTableListStreams',
  'aws-cdk-lib.aws_dynamodb.TableV2.grantWriteData',
  'aws-cdk-lib.aws_ec2.Volume.grantAttachVolume',
  'aws-cdk-lib.aws_ec2.Volume.grantAttachVolumeByResourceTag',
  'aws-cdk-lib.aws_ec2.Volume.grantDetachVolume',
  'aws-cdk-lib.aws_ec2.Volume.grantDetachVolumeByResourceTag',
  'aws-cdk-lib.aws_ecr.Repository.grant',
  'aws-cdk-lib.aws_ecr.Repository.grantPull',
  'aws-cdk-lib.aws_ecr.Repository.grantPullPush',
  'aws-cdk-lib.aws_ecr.Repository.grantPush',
  'aws-cdk-lib.aws_ecr.Repository.grantRead',
  'aws-cdk-lib.aws_ecr.RepositoryBase.grant',
  'aws-cdk-lib.aws_ecr.RepositoryBase.grantPull',
  'aws-cdk-lib.aws_ecr.RepositoryBase.grantPullPush',
  'aws-cdk-lib.aws_ecr.RepositoryBase.grantPush',
  'aws-cdk-lib.aws_ecr.RepositoryBase.grantRead',
  'aws-cdk-lib.aws_ecs.Cluster.grantTaskProtection',
  'aws-cdk-lib.aws_ecs.Ec2TaskDefinition.grantRun',
  'aws-cdk-lib.aws_ecs.ExternalTaskDefinition.grantRun',
  'aws-cdk-lib.aws_ecs.FargateTaskDefinition.grantRun',
  'aws-cdk-lib.aws_ecs.TaskDefinition.grantRun',
  'aws-cdk-lib.aws_efs.FileSystem.grant',
  'aws-cdk-lib.aws_efs.FileSystem.grantRead',
  'aws-cdk-lib.aws_efs.FileSystem.grantReadWrite',
  'aws-cdk-lib.aws_efs.FileSystem.grantRootAccess',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantIndexRead',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantIndexReadWrite',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantIndexWrite',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantPathRead',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantPathReadWrite',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantPathWrite',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantRead',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantReadWrite',
  'aws-cdk-lib.aws_elasticsearch.Domain.grantWrite',
  'aws-cdk-lib.aws_events.EventBus.grantAllPutEvents',
  'aws-cdk-lib.aws_events.EventBus.grantPutEventsTo',
  'aws-cdk-lib.aws_iam.LazyRole.grant',
  'aws-cdk-lib.aws_iam.LazyRole.grantAssumeRole',
  'aws-cdk-lib.aws_iam.LazyRole.grantPassRole',
  'aws-cdk-lib.aws_iam.Role.grant',
  'aws-cdk-lib.aws_iam.Role.grantAssumeRole',
  'aws-cdk-lib.aws_iam.Role.grantPassRole',
  'aws-cdk-lib.aws_kinesis.Stream.grant',
  'aws-cdk-lib.aws_kinesis.Stream.grantRead',
  'aws-cdk-lib.aws_kinesis.Stream.grantReadWrite',
  'aws-cdk-lib.aws_kinesis.Stream.grantWrite',
  'aws-cdk-lib.aws_kinesis.StreamConsumer.grant',
  'aws-cdk-lib.aws_kinesis.StreamConsumer.grantRead',
  'aws-cdk-lib.aws_kinesisfirehose.DeliveryStream.grant',
  'aws-cdk-lib.aws_kinesisfirehose.DeliveryStream.grantPutRecords',
  'aws-cdk-lib.aws_kms.Alias.grant',
  'aws-cdk-lib.aws_kms.Alias.grantDecrypt',
  'aws-cdk-lib.aws_kms.Alias.grantEncrypt',
  'aws-cdk-lib.aws_kms.Alias.grantEncryptDecrypt',
  'aws-cdk-lib.aws_kms.Alias.grantGenerateMac',
  'aws-cdk-lib.aws_kms.Alias.grantSign',
  'aws-cdk-lib.aws_kms.Alias.grantSignVerify',
  'aws-cdk-lib.aws_kms.Alias.grantVerify',
  'aws-cdk-lib.aws_kms.Alias.grantVerifyMac',
  'aws-cdk-lib.aws_kms.Key.grant',
  'aws-cdk-lib.aws_kms.Key.grantAdmin',
  'aws-cdk-lib.aws_kms.Key.grantDecrypt',
  'aws-cdk-lib.aws_kms.Key.grantEncrypt',
  'aws-cdk-lib.aws_kms.Key.grantEncryptDecrypt',
  'aws-cdk-lib.aws_kms.Key.grantGenerateMac',
  'aws-cdk-lib.aws_kms.Key.grantSign',
  'aws-cdk-lib.aws_kms.Key.grantSignVerify',
  'aws-cdk-lib.aws_kms.Key.grantVerify',
  'aws-cdk-lib.aws_kms.Key.grantVerifyMac',
  'aws-cdk-lib.aws_lambda.Alias.grantInvoke',
  'aws-cdk-lib.aws_lambda.Alias.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.Alias.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.Alias.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.DockerImageFunction.grantInvoke',
  'aws-cdk-lib.aws_lambda.DockerImageFunction.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.DockerImageFunction.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.DockerImageFunction.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.Function.grantInvoke',
  'aws-cdk-lib.aws_lambda.Function.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.Function.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.Function.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.FunctionBase.grantInvoke',
  'aws-cdk-lib.aws_lambda.FunctionBase.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.FunctionBase.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.FunctionBase.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.FunctionUrl.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.QualifiedFunctionBase.grantInvoke',
  'aws-cdk-lib.aws_lambda.QualifiedFunctionBase.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.QualifiedFunctionBase.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.QualifiedFunctionBase.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.SingletonFunction.grantInvoke',
  'aws-cdk-lib.aws_lambda.SingletonFunction.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.SingletonFunction.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.SingletonFunction.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda.Version.grantInvoke',
  'aws-cdk-lib.aws_lambda.Version.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda.Version.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda.Version.grantInvokeVersion',
  'aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.grantInvoke',
  'aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.grantInvokeLatestVersion',
  'aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.grantInvokeUrl',
  'aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.grantInvokeVersion',
  'aws-cdk-lib.aws_logs.LogGroup.grant',
  'aws-cdk-lib.aws_logs.LogGroup.grantRead',
  'aws-cdk-lib.aws_logs.LogGroup.grantWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantIndexRead',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantIndexReadWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantIndexWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantPathRead',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantPathReadWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantPathWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantRead',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantReadWrite',
  'aws-cdk-lib.aws_opensearchservice.Domain.grantWrite',
  'aws-cdk-lib.aws_rds.DatabaseCluster.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseCluster.grantDataApiAccess',
  'aws-cdk-lib.aws_rds.DatabaseClusterBase.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseClusterBase.grantDataApiAccess',
  'aws-cdk-lib.aws_rds.DatabaseClusterFromSnapshot.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseClusterFromSnapshot.grantDataApiAccess',
  'aws-cdk-lib.aws_rds.DatabaseInstance.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseInstanceBase.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseInstanceFromSnapshot.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseInstanceReadReplica.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseProxy.grantConnect',
  'aws-cdk-lib.aws_rds.DatabaseSecret.grantRead',
  'aws-cdk-lib.aws_rds.DatabaseSecret.grantWrite',
  'aws-cdk-lib.aws_rds.ServerlessCluster.grantDataApiAccess',
  'aws-cdk-lib.aws_rds.ServerlessClusterFromSnapshot.grantDataApiAccess',
  'aws-cdk-lib.aws_route53.HostedZone.grantDelegation',
  'aws-cdk-lib.aws_route53.PrivateHostedZone.grantDelegation',
  'aws-cdk-lib.aws_route53.PublicHostedZone.grantDelegation',
  'aws-cdk-lib.aws_s3.Bucket.grantDelete',
  'aws-cdk-lib.aws_s3.Bucket.grantPublicAccess',
  'aws-cdk-lib.aws_s3.Bucket.grantPut',
  'aws-cdk-lib.aws_s3.Bucket.grantPutAcl',
  'aws-cdk-lib.aws_s3.Bucket.grantRead',
  'aws-cdk-lib.aws_s3.Bucket.grantReadWrite',
  'aws-cdk-lib.aws_s3.Bucket.grantReplicationPermission',
  'aws-cdk-lib.aws_s3.Bucket.grantWrite',
  'aws-cdk-lib.aws_s3.BucketBase.grantDelete',
  'aws-cdk-lib.aws_s3.BucketBase.grantPublicAccess',
  'aws-cdk-lib.aws_s3.BucketBase.grantPut',
  'aws-cdk-lib.aws_s3.BucketBase.grantPutAcl',
  'aws-cdk-lib.aws_s3.BucketBase.grantRead',
  'aws-cdk-lib.aws_s3.BucketBase.grantReadWrite',
  'aws-cdk-lib.aws_s3.BucketBase.grantReplicationPermission',
  'aws-cdk-lib.aws_s3.BucketBase.grantWrite',
  'aws-cdk-lib.aws_scheduler.ScheduleGroup.grant',
  'aws-cdk-lib.aws_scheduler.ScheduleGroup.grantDeleteSchedules',
  'aws-cdk-lib.aws_scheduler.ScheduleGroup.grantReadSchedules',
  'aws-cdk-lib.aws_scheduler.ScheduleGroup.grantWriteSchedules',
  'aws-cdk-lib.aws_secretsmanager.Secret.grantRead',
  'aws-cdk-lib.aws_secretsmanager.Secret.grantWrite',
  'aws-cdk-lib.aws_secretsmanager.SecretTargetAttachment.grantRead',
  'aws-cdk-lib.aws_secretsmanager.SecretTargetAttachment.grantWrite',
  'aws-cdk-lib.aws_ses.EmailIdentity.grant',
  'aws-cdk-lib.aws_ses.EmailIdentity.grantSendEmail',
  'aws-cdk-lib.aws_sns.Topic.grantPublish',
  'aws-cdk-lib.aws_sns.Topic.grantSubscribe',
  'aws-cdk-lib.aws_sns.TopicBase.grantPublish',
  'aws-cdk-lib.aws_sns.TopicBase.grantSubscribe',
  'aws-cdk-lib.aws_sqs.Queue.grant',
  'aws-cdk-lib.aws_sqs.Queue.grantConsumeMessages',
  'aws-cdk-lib.aws_sqs.Queue.grantPurge',
  'aws-cdk-lib.aws_sqs.Queue.grantSendMessages',
  'aws-cdk-lib.aws_sqs.QueueBase.grant',
  'aws-cdk-lib.aws_sqs.QueueBase.grantConsumeMessages',
  'aws-cdk-lib.aws_sqs.QueueBase.grantPurge',
  'aws-cdk-lib.aws_sqs.QueueBase.grantSendMessages',
  'aws-cdk-lib.aws_ssm.StringListParameter.grantRead',
  'aws-cdk-lib.aws_ssm.StringListParameter.grantWrite',
  'aws-cdk-lib.aws_ssm.StringParameter.grantRead',
  'aws-cdk-lib.aws_ssm.StringParameter.grantWrite',
  'aws-cdk-lib.aws_stepfunctions.Activity.grant',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grant',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantExecution',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantRead',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantRedriveExecution',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantStartExecution',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantStartSyncExecution',
  'aws-cdk-lib.aws_stepfunctions.StateMachine.grantTaskResponse',
  'aws-cdk-lib.triggers.TriggerFunction.grantInvoke',
  'aws-cdk-lib.triggers.TriggerFunction.grantInvokeLatestVersion',
  'aws-cdk-lib.triggers.TriggerFunction.grantInvokeUrl',
  'aws-cdk-lib.triggers.TriggerFunction.grantInvokeVersion',
]);

export const grantsLinter = new Linter(assembly => assembly.allClasses
  .filter(cls => cls.ancestors.some(ancestor => ancestor.fqn === 'aws-cdk-lib.Resource')));

grantsLinter.add({
  code: 'grant-method',
  message: '"grant" methods should not be defined in constructs. Use a Grants class instead.',
  eval: e => {
    const grantMethods = e.ctx.allMethods.filter(m =>
      m.name.startsWith('grant') && m.returns.type.fqn === 'aws-cdk-lib.aws_iam.Grant',
    );

    grantMethods.forEach((method) => {
      const fqn = memberFqn(method);
      const isExempt = allowList.has(fqn);
      e.assert(isExempt, fqn);
    });
  },
});

